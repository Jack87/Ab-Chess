window.AbChess=window.AbChess||function(e,t){"use strict";function n(e){var t={activeColor:"",allowedCastles:"",enPassantSquare:"",fenString:e,fullmoveNumber:0,halfmoveClock:0,occupiedSquares:null};return t.checkMoveLegality=function(e){var n=e.substr(3,2),a="",r="",o=e.substr(0,2),i=[],s={};return h.move.test(e)&&t.occupiedSquares.hasOwnProperty(o)?(r=t.occupiedSquares[o]===t.occupiedSquares[o].toLowerCase()?c.black:c.white,t.activeColor!==r?!1:t.occupiedSquares.hasOwnProperty(n)&&(a=t.occupiedSquares[n]===t.occupiedSquares[n].toLowerCase()?c.black:c.white,a===r)?!1:(s=t.getNextPosition(e),s.isInCheck(t.activeColor)?!1:(i=t.getTargets(o,!1),i.some(function(e){return e===n})))):!1},t.getKingSquare=function(e){var n=e===c.black?c.blackKing:c.whiteKing;return Object.keys(t.occupiedSquares).find(function(e){return t.occupiedSquares[e]===n})},t.getLegalMoves=function(){var e=[],n=[];return n=t.getPiecesPlaces(t.activeColor),n.forEach(function(n){var a=t.getLegalSquares(n);a.forEach(function(t){var a=n+"-"+t;e.push(a)})}),e},t.getLegalSquares=function(e){var n=[],a=[];return a=t.getTargets(e,!1),a.forEach(function(a){var r=e+"-"+a;t.checkMoveLegality(r)&&n.push(a)}),n},t.getLineTargets=function(e,n){var a=[],r="",o=0,i="",s=[],u=t.occupiedSquares[e],l=0,g=[];return o=c.columns.indexOf(e[0])+1,l=Number(e[1]),r=u.toLowerCase()===u?c.black:c.white,a=t.getPiecesPlaces(r),i=r===c.black?c.white:c.black,s=t.getPiecesPlaces(i),n.forEach(function(e){for(var t=e[0],n=e[1],r="",i=o+t,u=l+n;i>0&&u>0&&9>i&&9>u&&(r=c.columns[i-1]+u,!(a.indexOf(r)>-1))&&(g.push(r),!(s.indexOf(r)>-1));)i+=t,u+=n}),g},t.getNextActiveColor=function(){return t.activeColor===c.white?c.black:c.white},t.getNextAllowedCastles=function(e){function n(e,t,n){r.indexOf(e)>-1&&(u===t||u===n||a===n)&&(r=r.replace(e,""))}var a="",r=t.allowedCastles,o=[c.whiteKing,c.blackKing],i=[c.whiteQueen,c.blackQueen],s=[1,8],u="";return"-"===r?r:(u=e.substr(0,2),a=e.substr(3,2),s.forEach(function(e,t){var a=c.columns[7]+e,r=c.columns[4]+e,s=c.columns[0]+e;n(o[t],r,a),n(i[t],r,s)}),""===r&&(r="-"),r)},t.getNextEnPassant=function(e){var n=0,a="",r="-",o="",i=0,s=e.substr(0,2);return o=t.occupiedSquares[s],o.toLowerCase()!==c.blackPawn?r:(i=Number(s[1]),a=e.substr(3,2),n=Number(a[1]),n-i===2&&(r=s[0]+"3"),i-n===2&&(r=s[0]+"6"),r)},t.getNextFullmoveNumber=function(){return t.activeColor===c.black?t.fullmoveNumber+1:t.fullmoveNumber},t.getNextHalfmoveClock=function(e){var n=e.substr(3,2),a="",r=e.substr(0,2),o=!1;return a=t.occupiedSquares[r],o=t.occupiedSquares.hasOwnProperty(n),a.toLowerCase()===c.blackPawn||o?0:t.halfmoveClock+1},t.getNextPosition=function(e,a){var r="",o="",i="",s="",c=0,u=0,l="";return l=t.getNextPositionString(e,a),r=t.getNextActiveColor(),o=t.getNextAllowedCastles(e),i=t.getNextEnPassant(e),u=t.getNextHalfmoveClock(e),c=t.getNextFullmoveNumber(),s=l+" "+r+" "+o+" "+i+" "+u+" "+c,new n(s)},t.getNextPositionString=function(e,a){var r=e.substr(3,2),o="",i={},s="",u="",l="",g=e.substr(0,2);return i=n.fenToObject(t.fenString),s=i[g],s.toLowerCase()===c.blackKing&&h.castle.test(e)?(r[0]===c.columns[2]?(l=c.columns[0],u=c.columns[3]):(l=c.columns[7],u=c.columns[5]),l+=r[1],u+=r[1],delete i[l],i[u]=g[1]===c.rows[0]?c.whiteRook:c.blackRook):s.toLowerCase()===c.blackPawn&&(r===t.enPassantSquare&&h.enPassant.test(e)&&(o=t.enPassantSquare[0]+g[1],delete i[o]),h.promotion.test(e)&&(a=a||c.blackQueen,s=r[1]===c.rows[0]?a.toLowerCase():a.toUpperCase())),delete i[g],i[r]=s,n.objectToFEN(i)},t.getPiecesPlaces=function(e){var n=t.occupiedSquares,a=[];return Object.keys(n).forEach(function(n){var r=t.occupiedSquares[n];(e===c.white&&r===r.toUpperCase()||e===c.black&&r===r.toLowerCase())&&a.push(n)}),a},t.getTargets=function(e,n){var a=t.occupiedSquares[e],r=[];return a.toLowerCase()===c.blackBishop?t.getLineTargets(e,c.bishopVectors):a.toLowerCase()===c.blackKing?t.getTargetsKing(e,n):a.toLowerCase()===c.blackKnight?t.getVectorsTargets(e,c.knightVectors):a.toLowerCase()===c.blackPawn?t.getTargetsPawn(e,n):a.toLowerCase()===c.blackQueen?(r=c.bishopVectors.concat(c.rookVectors),t.getLineTargets(e,r)):t.getLineTargets(e,c.rookVectors)},t.getTargetsCastle=function(e){function n(e){var n=e+v[u];return!t.occupiedSquares.hasOwnProperty(n)}var a=[c.columns[5],c.columns[3]],r=[[c.whiteKing,c.blackKing],[c.whiteQueen,c.blackQueen]],o="",i=[["f","g"],["b","c","d"]],s=[c.black,c.white],u=0,l=[c.columns[6],c.columns[2]],g=t.occupiedSquares[e],v=[c.rows[0],c.rows[7]],m=[];return u=g.toUpperCase()===g?0:1,o=c.columns[4]+v[u],e!==o||t.isControlledBy(o,s[u])?m:(r.forEach(function(e,r){var o="";-1!==t.allowedCastles.indexOf(e[u])&&(o=a[r]+v[u],t.isControlledBy(o,s[u])||i[r].every(n)&&(o=l[r]+v[u],m.push(o)))}),m)},t.getTargetsKing=function(e,n){var a=[],r="",o="",i=[],s=[],u=t.occupiedSquares[e],l=[];return s=t.getVectorsTargets(e,c.kingVectors),r=u.toLowerCase()===u?c.white:c.black,o=t.getKingSquare(r),i=t.getVectorsTargets(o,c.kingVectors),l=s.filter(function(e){return-1===i.indexOf(e)}),n?l:(a=t.getTargetsCastle(e),l=l.concat(a))},t.getTargetsPawn=function(e,n){var a=t.getTargetsPawnAttack(e,n);return n?a:a.concat(t.getTargetsPawnMove(e))},t.getTargetsPawnAttack=function(e,n){var a=[-1,1],r=0,o=0,i="",s=[],u=t.occupiedSquares[e],l=0,g=[],v=0;return r=c.columns.indexOf(e[0])+1,l=Number(e[1]),u.toLowerCase()===u?(o=-1,i=c.white):(o=1,i=c.black),v=l+o,s=t.getPiecesPlaces(i),a.forEach(function(e){var a=r+e,o=c.columns[a-1]+v;s.indexOf(o)>-1||t.enPassantSquare===o?g.push(o):n&&g.push(o)}),g},t.getTargetsPawnMove=function(e){var n=0,a=0,r=t.occupiedSquares[e],o=0,i=[],s=0,u=0,l="";return n=c.columns.indexOf(e[0])+1,o=Number(e[1]),a=r.toLowerCase()===r?-1:1,s=n,u=o+a,l=c.columns[s-1]+u,t.occupiedSquares.hasOwnProperty(l)?i:(i.push(l),(2===o&&1===a||7===o&&-1===a)&&(u=o+2*a,l=c.columns[s-1]+u,t.occupiedSquares.hasOwnProperty(l)||i.push(l)),i)},t.getVectorsTargets=function(e,n){var a=[],r="",o=0,i=t.occupiedSquares[e],s=0,u=[];return r=i.toLowerCase()===i?c.black:c.white,a=t.getPiecesPlaces(r),o=c.columns.indexOf(e[0])+1,s=Number(e[1]),n.forEach(function(e){var t=0,n=0,r="";t=o+e[0],n=s+e[1],1>t||t>8||1>n||n>8||(r=c.columns[t-1]+n,-1===a.indexOf(r)&&u.push(r))}),u},t.hasLegalMoves=function(){var e=t.getPiecesPlaces(t.activeColor);return e.some(function(e){var n=t.getLegalSquares(e);return n.length>0})},t.isCheckmate=function(){var e=t.isInCheck(t.activeColor);return e?!t.hasLegalMoves():!1},t.isControlledBy=function(e,n){var a=t.getPiecesPlaces(n);return a.some(function(n){var a=t.getTargets(n,!0);return a.indexOf(e)>-1})},t.isDrawBy50MovesRule=function(){return t.halfmoveClock>99},t.isDrawByInsufficientMaterial=function(){function e(e,t){return e.length!==t.length?!1:e.every(function(e,n){return t[n]===e})}var n=[],a=!1,r=[[c.blackKing,c.blackBishop],[c.blackKing,c.blackKnight],[c.blackKing,c.blackKnight,c.blackKnight]],o=[],i=[];return n=t.getPiecesPlaces(c.black),n.length>3?!1:(i=t.getPiecesPlaces(c.white),i.length>3?!1:n.length>1&&(n.forEach(function(e){var n=t.occupiedSquares[e];o.push(n)}),a=r.some(function(t){return e(t,o)}),!a)?!1:1===i.length?!0:(o=[],i.forEach(function(e){var n=t.occupiedSquares[e];o.push(n.toLowerCase())}),r.some(function(t){return e(t,o)})))},t.isInCheck=function(e){var n="",a="";return n=e===c.white?c.black:c.white,a=t.getKingSquare(e),t.isControlledBy(a,n)},t.initialize=function(){var a=[];if(!n.isValidFEN(e))throw new Error(g.invalidFEN);a=h.fen.exec(e),t.activeColor=a[1],t.allowedCastles=a[2],t.enPassantSquare=a[3],t.fullmoveNumber=Number(a[5]),t.halfmoveClock=Number(a[4]),t.occupiedSquares=n.fenToObject(e)},t.initialize(),t}function a(){var e={comments:[],fenStrings:[c.defaultFEN],moves:[],pgnMoves:[],tags:null};return e.addMove=function(t,n){var a=e.fenStrings.length-1,r=e.getNthPosition(a),o={},i="";n=n||"",o=r.getNextPosition(t,n),e.fenStrings.push(o.fenString),e.setResult(o),e.moves.push(t),i=e.getPGNMove(a,n),e.pgnMoves.push(i)},e.exportPGN=function(){var t=0,n="\n",a=80,r="";return Object.keys(e.tags).forEach(function(t){var a=e.tags[t];r+="["+t+' "'+a+'"]'+n}),r+=n,e.pgnMoves.forEach(function(e,o){var i="";0!==t&&(i=" "),o%2===0&&(i+=o/2+1+". "),i+=e,t+=i.length,t>=a&&(r+=n,t=i.length),r+=i}),r+" "+e.tags.Result+n+n},e.getNthPosition=function(t){var a="",r=0;if(r=e.fenStrings.length-1,"number"!=typeof t||0>t||t>r)throw new Error(g.invalidParameter);return a=e.fenStrings[t],new n(a)},e.getPGNKing=function(t){var n="",a=e.moves[t],r="",o="",i=e.getNthPosition(t),s=a.substr(0,2);return o=i.occupiedSquares[s],n=a.substr(3,2),h.castle.test(a)?r=n[0]===c.columns[2]?c.castleQueenSymbol:c.castleKingSymbol:(r=o.toUpperCase(),i.occupiedSquares.hasOwnProperty(n)&&(r+=c.captureSymbol),r+=n),r},e.getPGNMove=function(t,n){var a=e.moves[t],r="",o="",i=e.getNthPosition(t),s=a.substr(0,2);return o=i.occupiedSquares[s],r=o.toLowerCase()===c.blackKing?e.getPGNKing(t):o.toLowerCase()===c.blackPawn?e.getPGNPawn(t,n):e.getPGNPiece(t),r+e.getPGNSymbol(t,n)},e.getPGNPawn=function(t,n){var a="",r=!1,o=e.moves[t],i="",s=e.getNthPosition(t),u=o.substr(0,2);return a=o.substr(3,2),r=s.occupiedSquares.hasOwnProperty(a),(r||a===s.enPassantSquare)&&(i=u[0]+c.captureSymbol),i+=a,h.promotion.test(o)&&(i+=c.promotionSymbol+n.toUpperCase()),i},e.getPGNPiece=function(t){var n="",a=[],r=e.moves[t],o={},i="",s="",u=e.getNthPosition(t),l=!1,g=!1,v=r.substr(0,2);return o=u.occupiedSquares,s=o[v],i=s.toUpperCase(),n=r.substr(3,2),a=Object.keys(o).filter(function(e){var t=[],a=o[e];return a!==s||e===v?!1:(t=u.getLegalSquares(e),t.indexOf(n)>-1)}),a.length>0&&(l=a.some(function(e){return e[0]===v[0]}),g=a.some(function(e){return e[1]===v[1]}),i+=l?g?v:v[1]:v[0]),o.hasOwnProperty(n)&&(i+=c.captureSymbol),i+=n},e.getPGNSymbol=function(t,n){var a=e.moves[t],r={},o=e.getNthPosition(t);return r=o.getNextPosition(a,n),r.isInCheck(r.activeColor)?r.hasLegalMoves()?c.checkSymbol:c.checkmateSymbol:""},e.getSimpleKingMove=function(t){var n="",a=[],r=e.pgnMoves[t],o=e.getNthPosition(t),i="",s="";return a=r.match(h.pgnKingMove),null!==r.match(h.pgnCastle)?(i=o.activeColor===c.white?c.rows[0]:c.rows[7],s=c.columns[4]+i,n=r===c.castleKingSymbol?c.columns[6]+i:c.columns[2]+i):(n=a[1],s=o.getKingSquare(o.activeColor)),s+"-"+n},e.getSimpleMove=function(t,n){if(h.pgnKingMove.test(n))return e.getSimpleKingMove(t);if(h.pgnPawnMove.test(n))return e.getSimplePawnMove(t);if(h.pgnPieceMove.test(n))return e.getSimplePieceMove(t);throw new SyntaxError(g.invalidParameter)},e.getSimplePawnMove=function(t){var n="",a="",r=[],o={},i=e.pgnMoves[t],s="",u="",l="";return r=i.match(h.pgnPawnMove),n=r[1],a=r[2],h.pgnPromotion.test(i)&&(u=r[3]),s=t%2===0?c.whitePawn:c.blackPawn,o.piece=s,o.ambiguity=n,o.arrival=a,l=e.getSimpleStart(t,o),l+"-"+a+u},e.getSimplePieceMove=function(t){var n="",a="",r=[],o={},i=e.pgnMoves[t],s="",c="";return r=i.match(h.pgnPieceMove),n=r[1],a=r[2],s=i[0],o.piece=s,o.ambiguity=n,o.arrival=a,c=e.getSimpleStart(t,o),c+"-"+a},e.getSimpleStart=function(t,n){var a=[],r=e.getNthPosition(t);return a=r.getPiecesPlaces(r.activeColor),a.find(function(e){var t=[],a=r.occupiedSquares[e];return a.toLowerCase()!==n.piece.toLowerCase()?!1:(t=r.getLegalSquares(e),-1===t.indexOf(n.arrival)?!1:""===n.ambiguity?!0:e.indexOf(n.ambiguity)>-1)})},e.importMoves=function(){var t={};t=e.getNthPosition(0),e.pgnMoves.forEach(function(n,a){var r=e.getSimpleMove(a,n),o={},i="";r.indexOf(c.promotionSymbol)>-1&&(i=r[r.length-1],r=r.replace(h.pgnPromotion,"")),e.moves.push(r),o=t.getNextPosition(r,i),e.fenStrings.push(o.fenString),t=o})},e.importPGNMoves=function(t){for(var n=[];h.comment.test(t);)t=t.replace(h.comment,"");for(;h.variation.test(t);)t=t.replace(h.variation,"");t=t.replace(/\s{2,}/gm," "),n=t.match(h.pgnMove),n.forEach(function(t){t=t.replace(h.pgnMoveNumber,""),e.pgnMoves.push(t)})},e.importTags=function(t){var n=t.match(h.tagPair);n.forEach(function(t){var n=h.tagPairCapture.exec(t);e.tags[n[1]]=n[2]})},e.initialize=function(){var t={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"};e.tags={},Object.keys(t).forEach(function(n){e.tags[n]=t[n]})},e.isInCheck=function(t){var n="",a={};return a=e.getNthPosition(t),n=a.activeColor,a.isInCheck(n)},e.isLegal=function(t,n){var a=e.getNthPosition(t);return a.checkMoveLegality(n)},e.setPGN=function(t,n){if(!a.isValidPGN(t))throw new SyntaxError(g.invalidPGN);e.initialize(),e.fenStrings=[c.defaultFEN],e.moves=[],e.pgnMoves=[],e.importTags(t),(void 0===n||n)&&(e.importPGNMoves(t),e.importMoves())},e.setResult=function(t){var n=!t.hasLegalMoves(),a=!1,r=e.tags.Result;n?(a=t.isInCheck(t.activeColor),r=a?t.activeColor===c.black?c.resultWhite:c.resultBlack:c.resultDraw):(t.isDrawByInsufficientMaterial()||t.isDrawBy50MovesRule())&&(r=c.resultDraw),e.tags.Result=r},e.initialize(),e}function r(e,t,n){var a={div:null,ghost:null,isAnimated:!1,name:e,square:null,url:t,width:n};return a.animateGhost=function(e){var t=[],n=[];return n[0]=e.start[0]+e.vectors[0],n[1]=e.start[1]+e.vectors[1],t[0]=Math.abs(n[0]-e.arrival[0]),t[1]=Math.abs(n[1]-e.arrival[1]),e.instant||t[0]===e.rest[0]&&t[1]===e.rest[1]?(null!==a.ghost.parentElement&&document.body.removeChild(a.ghost),a.ghost.style.transform="",a.div.style.opacity="1",void(a.isAnimated=!1)):(a.ghost.style.transform="translate("+e.vectors[0]*e.step+"px, "+e.vectors[1]*e.step+"px)",e.start=n,e.step+=1,void f(function(){a.animateGhost(e)}))},a.animatePut=function(e){f(function(){e.div.appendChild(a.div)})},a.animateRemove=function(){f(function(){var e=a.div.parentElement;e.removeChild(a.div)})},a.deselect=function(){var e=a.square.board;a.showLegalSquares(),e.markSelectedSquare&&(a.square.isSelected=!1,a.square.updateCSS()),e.selectedSquare=null},a.fadingPlace=function(e){var t=Number(a.div.style.opacity);0===t&&a.animatePut(e),t+=.1,a.div.style.opacity=t,1!==t&&f(function(){a.fadingPlace(e)})},a.fadingRemove=function(){var e=a.div.style.opacity;""===e&&(e=1),e-=.1,a.div.style.opacity=e,e>0?f(a.fadingRemove):a.animateRemove()},a.initialize=function(){var e="url('"+t+"')";a.div=document.createElement("DIV"),a.div.className=u.squarePiece,a.div.style.backgroundImage=e,a.div.addEventListener("mousedown",a.onMouseDown),a.ghost=document.createElement("DIV"),a.ghost.className=u.ghostPiece,a.ghost.style.backgroundImage=e},a.move=function(e,t){var n=[],r=[];t&&(n=m(e.arrival.div),r=m(a.square.div),a.setGhostPosition(r[0],r[1]),a.showGhost(),a.startGhostAnimation(r,n)),e.isCapture&&e.arrival.piece.fadingRemove(),a.animateRemove(),a.animatePut(e.arrival)},a.onMouseDown=function(e){var t=a.square.board;return e.preventDefault(),t.draggable&&!a.isAnimated&&0===e.button?(t.isDragging=!0,t.markOverflownSquare&&(a.square.isOverflown=!0,a.square.updateCSS()),a.setGhostPositionCursor(e),a.showGhost(),t.selectedSquare===a.square.name?void(t.hasDraggedClickedSquare=!0):void a.select()):void 0},a.put=function(e){e.isEmpty()||e.piece.remove(),e.piece=a,a.square=e},a.remove=function(){null!==a.square&&(a.square.piece=null)},a.select=function(){var e=a.square.board;null!==e.selectedSquare&&e.squares[e.selectedSquare].piece.deselect(),a.showLegalSquares(),e.markSelectedSquare&&(a.square.isSelected=!0,a.square.updateCSS()),e.selectedSquare=a.square.name},a.setGhostPosition=function(e,t){f(function(){a.ghost.style.left=e+"px",a.ghost.style.top=t+"px"})},a.setGhostPositionCursor=function(e){var t=e.clientX+window.pageXOffset-a.width/2,n=e.clientY+window.pageYOffset-a.width/2;a.setGhostPosition(t,n)},a.showGhost=function(){f(function(){a.div.style.opacity="0",a.ghost.style.height=a.width+"px",a.ghost.style.width=a.width+"px",document.body.appendChild(a.ghost)})},a.showLegalSquares=function(){var e=a.square.board,t=0,n={},r=[];e.markLegalSquares&&(t=e.game.fenStrings.length-1,n=e.game.getNthPosition(t),r=n.getLegalSquares(a.square.name),r.forEach(function(t){e.squares[t].showCanvas()}))},a.startGhostAnimation=function(e,t){var n={},r=[],o=[],i=[],s=a.square.board.animationSpeed,c=[];r[0]=Math.abs(e[0]-t[0]),r[1]=Math.abs(e[1]-t[1]),Math.max(r[0],r[1])<s?n.instant=!0:r.forEach(function(n,a){i[a]=e[a]<t[a]?1:-1,o[a]=n%s,c[a]=i[a]*(n-o[a])/s}),n.arrival=t,n.rest=o,n.start=e,n.step=1,n.vectors=c,a.isAnimated=!0,f(function(){a.animateGhost(n)})},a.initialize(),a}function o(e,t){var n={board:null,canvas:null,div:null,hasCircle:!1,isCheck:!1,isLastMove:!1,isOverflown:!1,isSelected:!1,name:e,piece:null,width:t};return n.drawFilledCircle=function(e){var t=n.canvas.getContext("2d"),a=Math.floor(n.width/8),r=Math.floor(n.width/2);n.canvas.className=u.squareCanvas,n.canvas.setAttribute("height",n.width+"px"),n.canvas.setAttribute("width",n.width+"px"),t.beginPath(),t.arc(r,r,a,0,2*Math.PI),t.fillStyle=e,t.fill()},n.getClassName=function(){var e=u.square+" ";return e+=o.isWhite(n.name)?u.whiteSquare:u.blackSquare,n.isLastMove&&(e+=" "+u.lastMoveSquare),n.isCheck&&(e+=" "+u.checkSquare),n.isOverflown&&(e+=" "+u.overflownSquare),n.isSelected&&(e+=" "+u.selectedSquare),e},n.initialize=function(){var t=o.isWhite(e)?u.square+" "+u.whiteSquare:u.square+" "+u.blackSquare,a=document.createElement("DIV");n.canvas=document.createElement("CANVAS"),n.div=a,a.className=t,a.addEventListener("click",n.onClick),a.addEventListener("mousedown",n.onMouseDown),a.addEventListener("mouseenter",function(){n.onMouseEnterLeave(!0)}),a.addEventListener("mouseleave",function(){n.onMouseEnterLeave(!1)}),a.addEventListener("mouseup",n.onMouseUp)},n.isEmpty=function(){return null===n.piece},n.onClick=function(){var e=n.board,t=n.isEmpty(),a=e.selectedSquare;if(e.clickable){if(n.name===a)return void n.piece.deselect();null===a?t||e.hasDraggedClickedSquare||n.piece.select():(e.squares[a].piece.deselect(),e.confirmMove(a,n.name,!0)||t||n.piece.select()),e.hasDraggedClickedSquare=!1}},n.onMouseDown=function(e){e.preventDefault()},n.onMouseEnterLeave=function(e){var t=n.board;t.isDragging&&t.markOverflownSquare&&(n.isOverflown=e,n.updateCSS())},n.onMouseUp=function(){var e=n.board,t=[],a=[],r={},o={};e.isDragging&&(e.markOverflownSquare&&(n.isOverflown=!1,n.updateCSS()),o=e.squares[e.selectedSquare],r=o.piece,r.deselect(),a=m(r.ghost),t=m(n.name!==o.name&&e.confirmMove(o.name,n.name,!1)?n.div:o.div),r.startGhostAnimation(a,t),e.isDragging=!1)},n.showCanvas=function(){f(n.hasCircle?function(){n.div.removeChild(n.canvas)}:function(){n.div.appendChild(n.canvas)}),n.hasCircle=!n.hasCircle},n.updateCSS=function(){var e=n.getClassName();f(function(){n.div.className=e})},n.initialize(),n}function i(e,t){var i={animationSpeed:t.animationSpeed,clickable:t.clickable,columnsBorder:null,container:null,draggable:t.draggable,game:null,hasDraggedClickedSquare:!1,imagesExtension:t.imagesExtension,imagesPath:t.imagesPath,isDragging:!1,isFlipped:t.flipped,legalMarksColor:t.legalMarksColor,markKingInCheck:t.markKingInCheck,markLastMove:t.markLastMove,markLegalSquares:t.markLegalSquares,markOverflownSquare:t.markOverflownSquare,markSelectedSquare:t.markSelectedSquare,notationBorder:t.notationBorder,pendingMove:null,promotionDiv:null,rowsBorder:null,selectedSquare:null,squares:null,squaresDiv:null,width:t.width};return i.addNavigationData=function(e,t){Object.keys(i.squares).forEach(function(e){var t=i.squares[e];t.piece=null}),t.forEach(function(e){e.square.piece=e}),e.forEach(function(e){var t=e.arrival,n=e.piece,a=e.start;void 0!==t&&(void 0===a?(t.piece=n,n.square=t):(t.piece=n,n.square=t))})},i.askPromotion=function(e){for(var t=[c.blackQueen,c.blackRook,c.blackBishop,c.blackKnight],n=i.promotionDiv;n.hasChildNodes();)n.removeChild(n.lastChild);t.forEach(function(t){var a=document.createElement("BUTTON"),r=i.imagesPath+e+t+i.imagesExtension;a.className=u.promotionButton,a.setAttribute("name",t),a.style.backgroundImage="url('"+r+"')",a.addEventListener("click",i.onPromote),n.appendChild(a)}),i.lock(),f(function(){n.style.display="block"})},i.clearHighlight=function(){Object.keys(i.squares).forEach(function(e){var t=i.squares[e];t.hasCircle&&t.showCanvas(),t.isCheck&&(t.isCheck=!1),t.isLastMove&&(t.isLastMove=!1),t.isSelected&&(t.isSelected=!1),t.updateCSS()}),i.selectedSquare=null},i.confirmMove=function(e,t,n){var a="",r=0,o=e+"-"+t,s="",u={};if(!h.move.test(o))throw new Error(g.invalidParameter);return r=i.game.fenStrings.length-1,i.game.isLegal(r,o)?(u=i.game.getNthPosition(r),s=u.occupiedSquares[e],s.toLowerCase()===c.blackPawn&&h.promotion.test(o)?(i.pendingMove=o,a=t[1]===c.rows[7]?c.white:c.black,i.askPromotion(a)):i.play(o,"",n),!0):!1},i.createBoard=function(){var e=c.columns.split(""),t=c.rows.split("");i.squaresDiv=document.createElement("DIV"),i.squaresDiv.style.width=i.width+"px",i.squaresDiv.style.height=i.width+"px",i.squaresDiv.className=u.squaresDiv,i.isFlipped?e=e.reverse():t=t.reverse(),t.forEach(function(t){e.forEach(function(e){var n=i.squares[e+t];i.squaresDiv.appendChild(n.div)})})},i.createColumnsBorder=function(){var e=c.columns.split("");i.columnsBorder=document.createElement("DIV"),i.columnsBorder.className=u.columnsBorder,i.columnsBorder.style.width=i.width+"px",i.isFlipped&&(e=e.reverse()),e.forEach(function(e){var t=document.createElement("DIV");t.className=u.columnsBorderFragment,t.innerHTML=e,i.columnsBorder.appendChild(t)})},i.createRowsBorder=function(){var e=Math.floor(i.width/8)+"px",t=c.rows.split("");i.rowsBorder=document.createElement("DIV"),i.rowsBorder.className=u.rowsBorder,i.rowsBorder.style.height=i.width+"px",i.isFlipped||(t=t.reverse()),t.forEach(function(t){var n=document.createElement("DIV");n.className=u.rowsBorderFragment,n.style.lineHeight=e,n.innerHTML=t,i.rowsBorder.appendChild(n)})},i.createSquares=function(){var e=c.columns.split(""),t=c.rows.split(""),n=Math.floor(i.width/8);i.squares={},e.forEach(function(e){t.forEach(function(t){var a=e+t,r=new o(a,n);r.drawFilledCircle(i.legalMarksColor),r.board=i,i.squares[a]=r})})},i.draw=function(){i.promotionDiv=document.createElement("DIV"),i.promotionDiv.className=u.promotionDiv,i.createBoard(),f(function(){i.squaresDiv.appendChild(i.promotionDiv),i.container.appendChild(i.squaresDiv)}),i.notationBorder&&(i.createRowsBorder(),f(function(){i.container.insertBefore(i.rowsBorder,i.squaresDiv)}),i.createColumnsBorder(),f(function(){i.container.appendChild(i.columnsBorder)}))},i.empty=function(){Object.keys(i.squares).forEach(function(e){var t=i.squares[e];t.isEmpty()||(t.piece.animateRemove(),t.piece.remove())})},i.getAnimations=function(e){var t=[],n=e.occupiedSquares,a=[],r=[],o=i.getPositionObject();return Object.keys(o).forEach(function(e){n[e]!==o[e]&&r.push(e)}),Object.keys(n).forEach(function(e){var s=!1,c=0;o[e]!==n[e]&&(s=r.some(function(a,r){var s={},u={},l={},g={};return n[e]!==o[a]?!1:(g=i.squares[a],u=i.squares[e],l=g.piece,s.start=g,s.arrival=u,s.piece=l,t.push(s),c=r,!0)}),s?r.splice(c,1):a.push(e))}),r.forEach(function(e){var n={},a={},r=i.squares[e];a=r.piece,n.start=r,n.piece=a,t.push(n)}),a.forEach(function(e){var a={},r=i.squares[e],o=n[e];a.arrival=r,a.piece=i.getNewPiece(o),t.push(a)}),t},i.getNewPiece=function(e){var t=e.toLowerCase()===e?c.black+e:c.white+e.toLowerCase(),n=i.imagesPath+t+i.imagesExtension,a=Math.floor(i.width/8);return new r(t,n,a)},i.getPositionObject=function(){var e={};return Object.keys(i.squares).forEach(function(t){var n="",a="",r=i.squares[t];r.isEmpty()||(a=r.piece.name,n=a[0]===c.white?a[1].toUpperCase():a[1].toLowerCase(),e[t]=n)}),e},i.getSimilarPieces=function(e){var t=e.occupiedSquares,n=i.getPositionObject(),a=[];return Object.keys(t).forEach(function(e){var r=t[e],o=n[e],s={};o===r&&(s=i.squares[e].piece,a.push(s))}),a},i.highlightKing=function(e){var t="";i.markKingInCheck&&e.isInCheck(e.activeColor)&&(t=e.getKingSquare(e.activeColor),i.squares[t].isCheck=!0,i.squares[t].updateCSS())},i.highlightLastMove=function(e){var t="",n="",a="";!i.markLastMove||1>e||(t=i.game.moves[e-1],n=t.substr(3,2),i.squares[n].isLastMove=!0,i.squares[n].updateCSS(),a=t.substr(0,2),i.squares[a].isLastMove=!0,i.squares[a].updateCSS())},i.initialize=function(){switch(i.container=document.getElementById(e),i.animationSpeed){case"slow":i.animationSpeed=12;break;case"normal":i.animationSpeed=8;break;case"fast":i.animationSpeed=4;break;case"instant":i.animationSpeed=1/0;break;default:i.animationSpeed=8}i.game=new a,document.addEventListener("mousemove",i.onMouseMove),document.addEventListener("mouseup",i.onMouseUp)},i.lock=function(){i.clickable=!1,i.draggable=!1},i.move=function(e,t,n){var a="",r={},o=!1,s={},u={},l=e.substr(0,2),g=i.squares[l];return u=g.piece,a=e.substr(3,2),r=i.squares[a],o=r.isEmpty(),s.arrival=r,s.isCapture=!o,u.move(s,n),u.remove(),u.put(r),h.castle.test(e)&&u.name[1]===c.blackKing?void i.moveCastle(a):void(u.name[1]===c.blackPawn&&(o&&h.enPassant.test(e)&&l[0]!==a[0]?i.moveEnPassant(a):h.promotion.test(e)&&i.movePromotion(u,a,t)))},i.moveCastle=function(e){var t={},n={},a="",r="";if(e[0]===c.columns[2]?(r=c.columns[0],a=c.columns[3]):e[0]===c.columns[6]&&(r=c.columns[7],a=c.columns[5]),r+=e[1],a+=e[1],i.squares[r].isEmpty())throw new Error(g.illegalMove);n=i.squares[r].piece,t.arrival=i.squares[a],t.isCapture=!1,n.move(t,!0),n.remove(),n.put(i.squares[a])},i.moveEnPassant=function(e){var t="",n={};if(t=e[1]===c.rows[2]?e[0]+c.rows[3]:e[0]+c.rows[4],n=i.squares[t],n.isEmpty())throw new Error(g.illegalMove);n.piece.fadingRemove(),n.piece.remove()},i.movePromotion=function(e,t,n){var a=i.squares[t],o={},s="",u="",l="",g=Math.floor(i.width/8);n=n||c.blackQueen,s=t[1]===c.rows[0]?c.black:c.white,u=s+n.toLowerCase(),l=i.imagesPath+u+i.imagesExtension,o=new r(u,l,g),e.fadingRemove(),e.remove(),o.fadingPlace(a),o.put(a)},i.navigate=function(e){var t=[],n=i.game.fenStrings.length-1,a={},r=[];if(0>e||e>n)throw new Error(g.invalidParameter);a=i.game.getNthPosition(e),i.updateHighlight(e,a),t=i.getAnimations(a),r=i.getSimilarPieces(a),i.performAnimations(t),i.addNavigationData(t,r),n>e?i.lock():i.unlock()},i.onMouseMove=function(e){var t={};i.isDragging&&(t=i.squares[i.selectedSquare],t.piece.setGhostPositionCursor(e))},i.onMouseUp=function(){var e=[],t={},n=[];i.isDragging&&(t=i.squares[i.selectedSquare],e=m(t.piece.ghost),n=m(t.div),t.piece.startGhostAnimation(e,n),t.piece.deselect(),i.isDragging=!1)},i.onPromote=function(e){i.play(i.pendingMove,e.target.name,!0),i.pendingMove=null,i.unlock(),f(function(){i.promotionDiv.style.display="none"})},i.performAnimations=function(e){e.forEach(function(e){var t=e.arrival,n={},a=e.piece,r=e.start;void 0===t?a.fadingRemove():void 0===r?a.fadingPlace(t):(n.arrival=t,n.isCapture=!1,a.move(n,!0))})},i.play=function(e,t,n){var a={},r=i.game.fenStrings.length-1,o={};i.move(e,t,n),i.game.addMove(e,t),a=i.game.getNthPosition(r),o=a.getNextPosition(e,t),i.updateHighlight(r+1,o),"function"==typeof v.onMovePlayed&&f(v.onMovePlayed)},i.setFEN=function(e){var t={};if(e=e||c.defaultFEN,!n.isValidFEN(e,!0))throw new SyntaxError(g.invalidFEN);i.empty(),t=n.fenToObject(e),Object.keys(t).forEach(function(e){var n=t[e],a=i.getNewPiece(n),r=i.squares[e];a.animatePut(r),a.put(r)})},i.unlock=function(){i.clickable=t.clickable,i.draggable=t.draggable},i.updateHighlight=function(e,t){i.clearHighlight(),i.highlightKing(t),i.highlightLastMove(e)},i.initialize(),i}var s={},c={bishopVectors:[[-1,-1],[-1,1],[1,-1],[1,1]],black:"b",blackBishop:"b",blackKing:"k",blackKnight:"n",blackPawn:"p",blackQueen:"q",blackRook:"r",captureSymbol:"x",castleKingSymbol:"O-O",castleQueenSymbol:"O-O-O",checkSymbol:"+",checkmateSymbol:"#",columns:"abcdefgh",defaultFEN:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",kingVectors:[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],knightVectors:[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],promotionSymbol:"=",resultBlack:"0-1",resultDraw:"1/2-1/2",resultWhite:"1-0",rookVectors:[[-1,0],[0,-1],[0,1],[1,0]],rows:"12345678",white:"w",whiteBishop:"B",whiteKing:"K",whiteKnight:"N",whitePawn:"P",whiteQueen:"Q",whiteRook:"R"},u={blackSquare:"square_black",checkSquare:"square_check",columnsBorder:"columns-border",columnsBorderFragment:"columns-border__fragment",ghostPiece:"ghost_piece",lastMoveSquare:"square_last-move",overflownSquare:"square_overflown",promotionButton:"promotion-button",promotionDiv:"promotion-div",rowsBorder:"rows-border",rowsBorderFragment:"rows-border__fragment",selectedSquare:"square_selected",square:"square",squareCanvas:"square__canvas",squarePiece:"square__piece",squaresDiv:"squares-div",whiteSquare:"square_white"},l={animationSpeed:"normal",clickable:!0,draggable:!0,flipped:!1,imagesExtension:".png",imagesPath:"images/wikipedia/",legalMarksColor:"steelblue",markKingInCheck:!0,markLastMove:!0,markLegalSquares:!0,markOverflownSquare:!0,markSelectedSquare:!0,notationBorder:!0,width:360},g={illegalMove:"Illegal move.",invalidFEN:"Invalid FEN string.",invalidParameter:"Invalid parameter.",invalidPGN:"Invalid PGN."},v={onMovePlayed:null},m=function(e){var t=e.getBoundingClientRect().left+window.pageXOffset,n=e.getBoundingClientRect().top+window.pageYOffset;return[Math.round(t),Math.round(n)]},f=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)},h={castle:/^e(?:1-c1|1-g1|8-c8|8-g8)$/,comment:/\{[^]+?\}/gm,enPassant:/^[a-h]4-[a-h]3|[a-h]5-[a-h]6$/,fen:/^(?:[bBkKnNpPqQrR1-8]{1,8}\/){7}[bBkKnNpPqQrR1-8]{1,8}\s(w|b)\s(KQ?k?q?|K?Qk?q?|K?Q?kq?|K?Q?k?q|-)\s([a-h][36]|-)\s(0|[1-9]\d*)\s([1-9]\d*)$/,fenRow:/^[bknpqr1]{8}|[bknpqr12]{7}|[bknpqr1-3]{6}|[bknpqr1-4]{5}|[bknpqr1-5]{4}|[bknpqr1-6]{3}|[bknpqr]7|7[bknpqr]|8$/i,move:/^[a-h][1-8]-[a-h][1-8]$/,pgnCastle:/^O-O(?:-O)?(?:\+|#)?$/,pgnKingMove:/^(?:Kx?([a-h][1-8])|O-O(?:-O)?)(?:\+|#)?$/,pgnMove:/(?:[1-9][0-9]*\.(?:\.\.)?\s*)?(?:O-O(?:-O)?|(?:[BNQR][a-h]?[1-8]?|K)x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:\=[BNQR])?)(?:\+|#)?/gm,pgnMoveNumber:/[1-9][0-9]*\.(?:\.\.)?\s?/,pgnPawnMove:/^([a-h]?)x?([a-h][1-8])(\=[BNQR])?(?:\+|#)?$/,pgnPieceMove:/^[BNQR]([a-h]?[1-8]?)x?([a-h][1-8])(?:\+|#)?$/,pgnPromotion:/\=[BNQR]$/,pgnShortMove:/^(?:O-O(?:-O)?|(?:[BNQR][a-h]?[1-8]?|K)x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:\=[BNQR])?)(?:\+|#)?$/,pieceChar:/[bknpqr]/i,promotion:/^[a-h]2-[a-h]1|[a-h]7-[a-h]8$/,result:/1-0|0-1|1\/2-1\/2|\*/,row:/[1-8]/,tagPair:/\[[A-Z][^]+?\s"[^]+?"\]/gm,tagPairCapture:/\[(\S+)\s"(.*)"/,tagPairsSection:/(?:\[[^]+?\s"[^]+?"\]\s+){7,}\s+/gm,variation:/\([^()]*?\)/gm};return n.fenToObject=function(e){var t={},n="",a=[];return n=e.replace(/\s.*/,""),a=n.split("/"),a.forEach(function(e,n){var a=1,r=8-n;e.split("").forEach(function(e){var n="";if(h.pieceChar.test(e))n=c.columns[a-1]+r,t[n]=e,a+=1;else{if(!h.row.test(e))throw new Error(g.invalidFEN);a+=Number(e)}})}),t},n.isValidFEN=function(e,t){var n=e.replace(/\s.*/,"").split("/");return t=t||!1,t||h.fen.test(e)?n.every(function(e){return h.fenRow.test(e)}):!1},n.objectToFEN=function(e){var t=c.columns.split(""),n="",a=c.rows.split("").reverse();return a.forEach(function(a,r){var o=0;t.forEach(function(t,i){e.hasOwnProperty(t+a)?(o>0&&(n+=o,o=0),n+=e[t+a]):o+=1,7>i||(o>0&&(n+=o),7>r&&(n+="/"))})}),n},a.isValidPGN=function(e){function t(e){return h.pgnMove.test(e)}var n=[],a=[];if(!h.tagPairsSection.test(e))return!1;for(e=e.replace(h.tagPairsSection,"");h.comment.test(e);)e=e.replace(h.comment,"");for(;h.variation.test(e);){if(a=e.match(h.variation),!a.every(t))return!1;e=e.replace(h.variation,"")}return n=e.match(h.pgnMove),n.length<1?!1:(e=e.replace(h.pgnMove,""),h.result.test(e))},o.isWhite=function(e){var t=0,n=0;return t=c.columns.indexOf(e[0])+1,n=Number(e[1]),n%2===0?t%2===1:t%2===0},t=t||{},Object.keys(l).forEach(function(e){t.hasOwnProperty(e)||(t[e]=l[e])}),s=new i(e,t),{DEFAULT_FEN:c.defaultFEN,draw:function(){s.createSquares(),s.draw()},flip:function(){function e(){for(;s.container.hasChildNodes();)s.container.removeChild(s.container.lastChild)}f(e),s.isFlipped=!s.isFlipped,s.draw()},getActiveColor:function(e){var t=s.game.getNthPosition(e);return t.activeColor},getFEN:function(e){var t=s.game.fenStrings.length-1;if("number"!=typeof e||0>e||e>t)throw new Error(g.invalidParameter);
return s.game.fenStrings[e]},getGameInfo:function(e){return s.game.tags[e]},getGameMoves:function(){return s.game.moves},getGameMovesPGN:function(){return s.game.pgnMoves},getLastPositionIndex:function(){return s.game.fenStrings.length-1},getLegalMoves:function(e){var t=s.game.getNthPosition(e);return t.getLegalMoves()},getPGN:function(){return s.game.exportPGN()},is50MovesDraw:function(e){var t=s.game.getNthPosition(e);return t.isDrawBy50MovesRule()},isCheckmate:function(e){var t=s.game.getNthPosition(e);return t.isCheckmate()},isInCheck:function(e){return s.game.isInCheck(e)},isInsufficientMaterialDraw:function(e){var t=s.game.getNthPosition(e);return t.isDrawByInsufficientMaterial()},isLegal:function(e,t){if(!h.move.test(t))throw new SyntaxError(g.invalidParameter);return s.game.isLegal(e,t)},isStalemate:function(e){var t="",n=s.game.getNthPosition(e);return t=n.activeColor,!n.isInCheck(t)&&!n.hasLegalMoves()},isValidFEN:function(e,t){return n.isValidFEN(e,t)},isValidPGN:function(e){return a.isValidPGN(e)},navigate:function(e){return s.navigate(e)},onMovePlayed:function(e){if("function"!=typeof e)throw new Error(g.invalidParameter);v.onMovePlayed=e},play:function(e,t){var n=0;if(!h.move.test(e))throw new SyntaxError(g.invalidParameter);if(n=s.game.fenStrings.length-1,!s.game.isLegal(n,e))throw new SyntaxError(g.illegalMove);s.play(e,t,!0)},reset:function(){s.setFEN(),s.clearHighlight(),s.unlock(),s.game=new a},setFEN:function(e){s.setFEN(e)},setGameInfo:function(e,t){s.game.tags[e]=t},setPGN:function(e,t){s.game.setPGN(e,t)}}};