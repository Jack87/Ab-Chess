window.AbChess=window.AbChess||function(e,t){"use strict";function n(e){var t={activeColor:"",allowedCastles:"",enPassantSquare:"",fenString:e,fullmoveNumber:0,halfmoveClock:0,occupiedSquares:null};return t.checkMoveLegality=function(e){var n="",a="",r="",o=[],i={};return k.move.test(e)?(r=e.substr(0,2),t.occupiedSquares.hasOwnProperty(r)?(a=t.occupiedSquares[r]===t.occupiedSquares[r].toLowerCase()?v.black:v.white,t.activeColor!==a?!1:(i=t.getNextPosition(e),i.isInCheck(t.activeColor)?!1:(o=t.getTargets(r,!1),n=e.substr(3,2),o.some(function(e){return e===n})))):!1):!1},t.getKingSquare=function(e){var n="",a="";return n=e===v.black?v.blackKing:v.whiteKing,Object.keys(t.occupiedSquares).every(function(e){var r=t.occupiedSquares[e];return r===n?(a=e,!1):!0}),a},t.getLegalMoves=function(){var e=[],n=[];return n=t.getPiecesPlaces(t.activeColor),n.forEach(function(n){var a=t.getLegalSquares(n);a.forEach(function(t){var a=n+"-"+t;e.push(a)})}),e},t.getLegalSquares=function(e){var n=[],a=[];return a=t.getTargets(e,!1),a.forEach(function(a){var r=e+"-"+a;t.checkMoveLegality(r)&&n.push(a)}),n},t.getLinearTargets=function(e,n,a){var r=[],o=0,i="",s=[],c=0,u=[];return o=v.columns.indexOf(e[0])+1,c=Number(e[1]),r=t.getPiecesPlaces(n),i=n===v.black?v.white:v.black,s=t.getPiecesPlaces(i),a.forEach(function(e){for(var t=e[0],n=e[1],a="",i=o+t,l=c+n;i>0&&l>0&&9>i&&9>l&&(a=v.columns[i-1]+l,!(r.indexOf(a)>-1))&&(u.push(a),!(s.indexOf(a)>-1));)i+=t,l+=n}),u},t.getNextActiveColor=function(){return t.activeColor===v.white?v.black:v.white},t.getNextAllowedCastles=function(e){var n=t.allowedCastles,a="",r="",o="",i="";return"-"===n?n:(r=n,i=e.substr(0,2),o=t.occupiedSquares[i],a=e.substr(3,2),n.search(/[kq]/)>-1&&(o===v.blackKing&&(r=n.replace(/[kq]/g,"")),("a8"===i||"a8"===a)&&(r=n.replace(/q/,"")),("h8"===i||"h8"===a)&&(r=n.replace(/k/,""))),n.search(/[KQ]/)>-1&&(o===v.whiteKing&&(r=n.replace(/[KQ]/g,"")),("a1"===i||"a1"===a)&&(r=n.replace(/Q/,"")),("h1"===i||"h1"===a)&&(r=n.replace(/K/,""))),""===r&&(r="-"),r)},t.getNextEnPassant=function(e){var n=0,a="",r="-",o="",i=0,s=e.substr(0,2);return o=t.occupiedSquares[s],o.toLowerCase()!==v.blackPawn?r:(i=Number(s[1]),a=e.substr(3,2),n=Number(a[1]),n-i===2&&(r=s[0]+"3"),i-n===2&&(r=s[0]+"6"),r)},t.getNextFullmoveNumber=function(){return t.activeColor===v.black?t.fullmoveNumber+1:t.fullmoveNumber},t.getNextHalfmoveClock=function(e){var n=e.substr(3,2),a="",r=e.substr(0,2),o=!1;return a=t.occupiedSquares[r],o=t.occupiedSquares.hasOwnProperty(n),a.toLowerCase()===v.blackPawn||o?0:t.halfmoveClock+1},t.getNextPosition=function(e,a){var r=e.substr(3,2),o="",i="",s="",c="",u="",l=0,g=0,f={},d="",h="",m="",p="",w=e.substr(0,2);return f=n.fenToObject(t.fenString),d=f[w],d.toLowerCase()===v.blackKing&&k.castle.test(e)?(r[0]===v.columns[2]?(p=v.columns[0]+r[1],m=v.columns[3]+r[1]):(p=v.columns[7]+r[1],m=v.columns[5]+r[1]),delete f[p],"e1"===w?f[m]=v.whiteRook:f[m]=v.blackRook):d.toLowerCase()===v.blackPawn&&(r===t.enPassantSquare&&k.enPassant.test(e)&&(o=t.enPassantSquare[0]+w[1],delete f[o]),k.promotion.test(e)&&(a=a||v.blackQueen,"1"===r[1]&&(d=a.toLowerCase()),"8"===r[1]&&(d=a.toUpperCase()))),delete f[w],f[r]=d,h=n.objectToFEN(f),i=t.getNextActiveColor(),s=t.getNextAllowedCastles(e),c=t.getNextEnPassant(e),g=t.getNextHalfmoveClock(e),l=t.getNextFullmoveNumber(),u=h+" "+i+" "+s+" "+c+" "+g+" "+l,new n(u)},t.getPGNKing=function(e){var n=e.substr(3,2),a="",r="",o=e.substr(0,2);return r=t.occupiedSquares[o],k.castle.test(e)?a=n[0]===v.columns[2]?v.castleQueenSymbol:v.castleKingSymbol:(a=r.toUpperCase(),t.occupiedSquares.hasOwnProperty(n)&&(a+=v.captureSymbol),a+=n),a},t.getPGNMove=function(e,n){var a=!1,r={},o="",i="",s=e.substr(0,2);switch(i=t.occupiedSquares[s],i.toLowerCase()){case v.blackBishop:case v.blackKnight:case v.blackQueen:case v.blackRook:o=t.getPGNPiece(e);break;case v.blackKing:o=t.getPGNKing(e);break;case v.blackPawn:o=t.getPGNPawn(e,n)}return r=t.getNextPosition(e,n),(a=r.isInCheck(r.activeColor))?o+=r.hasLegalMoves()?v.checkSymbol:v.checkmateSymbol:o},t.getPGNPawn=function(e,n){var a=e.substr(3,2),r=!1,o="",i=e.substr(0,2);return r=t.occupiedSquares.hasOwnProperty(a),(r||a===t.enPassantSquare)&&(o=i[0]+v.captureSymbol),o+=a,k.promotion.test(e)&&(o+=v.promotionSymbol+n.toUpperCase()),o},t.getPGNPiece=function(e){var n=!1,a=e.substr(3,2),r="",o=t.occupiedSquares,i="",s="",c=!1,u=!1,l=e.substr(0,2);return s=t.occupiedSquares[l],i=s.toUpperCase(),Object.keys(o).forEach(function(e){var r=[],o="";e!==l&&(c&&u||(o=t.occupiedSquares[e],o===s&&(r=t.getLegalSquares(e),-1!==r.indexOf(a)&&(e[0]===l[0]?c=!0:e[1]===l[1]&&(u=!0),n=!0))))}),n&&(r=c?u?l:l[1]:l[0],i+=r),o.hasOwnProperty(a)&&(i+=v.captureSymbol),i+=a},t.getPiecesPlaces=function(e){var n=t.occupiedSquares,a=[];return Object.keys(n).forEach(function(n){var r=t.occupiedSquares[n];(e===v.white&&r===r.toUpperCase()||e===v.black&&r===r.toLowerCase())&&a.push(n)}),a},t.getSimpleKingMove=function(e){var n="",a=[],r="",o="";return a=e.match(k.pgnKingMove),null!==e.match(k.pgnCastle)?(r=t.activeColor===v.white?"1":"8",o="e"+r,n=e===v.castleKingSymbol?"g"+r:"c"+r):(n=a[1],o=t.getKingSquare(t.activeColor)),o+"-"+n},t.getSimpleMove=function(e){if(k.pgnKingMove.test(e))return t.getSimpleKingMove(e);if(k.pgnPawnMove.test(e))return t.getSimplePawnMove(e);if(k.pgnPieceMove.test(e))return t.getSimplePieceMove(e);throw new SyntaxError(p.invalidParameter)},t.getSimplePawnMove=function(e){var n="",a="",r=[],o="",i="",s="";return r=e.match(k.pgnPawnMove),n=r[1],a=r[2],k.pgnPromotion.test(e)&&(i=r[3]),o=t.activeColor===v.white?v.whitePawn:v.blackPawn,s=t.getSimpleStart(o,a,n),s+"-"+a+i},t.getSimplePieceMove=function(e){var n="",a="",r=[],o="",i="";return r=e.match(k.pgnPieceMove),n=r[1],a=r[2],o=e[0],i=t.getSimpleStart(o,a,n),i+"-"+a},t.getSimpleStart=function(e,n,a){var r=t.getPiecesPlaces(t.activeColor);return r.find(function(r){var o=[],i=t.occupiedSquares[r];return i.toLowerCase()!==e.toLowerCase()?!1:(o=t.getLegalSquares(r),-1===o.indexOf(n)?!1:""===a?!0:r.indexOf(a)>-1)})},t.getTargets=function(e,n){var a="",r="",o=[],i=[];if(!t.occupiedSquares.hasOwnProperty(e))return o;switch(r=t.occupiedSquares[e],a=r.toLowerCase()===r?v.black:v.white,r.toLowerCase()){case v.blackBishop:o=t.getLinearTargets(e,a,v.bishopVectors);break;case v.blackKing:o=t.getTargetsKing(e,a,n);break;case v.blackKnight:o=t.getTargetsByVectors(e,a,v.knightVectors);break;case v.blackPawn:o=t.getTargetsPawn(e,a,n);break;case v.blackQueen:i=v.bishopVectors.concat(v.rookVectors),o=t.getLinearTargets(e,a,i);break;case v.blackRook:o=t.getLinearTargets(e,a,v.rookVectors)}return o},t.getTargetsByVectors=function(e,n,a){var r=[],o=0,i=0,s=[];return r=t.getPiecesPlaces(n),o=v.columns.indexOf(e[0])+1,i=Number(e[1]),a.forEach(function(e){var t=0,n=0,a="";t=o+e[0],n=i+e[1],1>t||t>8||1>n||n>8||(a=v.columns[t-1]+n,-1===r.indexOf(a)&&s.push(a))}),s},t.getTargetsCastle=function(e,n){function a(e){var n=e+d;return!t.occupiedSquares.hasOwnProperty(n)}var r="",o="",i="",s=["f","g"],c=!1,u="",l=["b","c","d"],g="",f="",d="",h=[];return n===v.white?(i=v.whiteKing,u=v.black,g=v.whiteQueen,d="1"):(i=v.blackKing,u=v.white,g=v.blackQueen,d="8"),o="e"+d,e!==o||t.isControlledBy(o,u)?h:(f="d"+d,t.allowedCastles.indexOf(g)>-1&&!t.isControlledBy(f,u)&&(c=l.every(a),c&&h.push("c"+d)),r="f"+d,t.allowedCastles.indexOf(i)>-1&&!t.isControlledBy(r,u)&&(c=s.every(a),c&&h.push("g"+d)),h)},t.getTargetsKing=function(e,n,a){var r=[],o="",i="",s=[],c=[],u=[];return c=t.getTargetsByVectors(e,n,v.kingVectors),o=n===v.black?v.white:v.black,i=t.getKingSquare(o),s=t.getTargetsByVectors(i,o,v.kingVectors),u=c.filter(function(e){return-1===s.indexOf(e)}),a?u:(r=t.getTargetsCastle(e,n),u=u.concat(r))},t.getTargetsPawn=function(e,n,a){var r=t.getTargetsPawnAttack(e,n,a);return a?r:r.concat(t.getTargetsPawnMove(e,n))},t.getTargetsPawnAttack=function(e,n,a){var r=[-1,1],o=0,i=0,s="",c=[],u=0,l=[],g=0;return o=v.columns.indexOf(e[0])+1,u=Number(e[1]),n===v.black?(i=-1,s=v.white):(i=1,s=v.black),g=u+i,c=t.getPiecesPlaces(s),r.forEach(function(e){var n=o+e,r=v.columns[n-1]+g;c.indexOf(r)>-1||t.enPassantSquare===r?l.push(r):a&&l.push(r)}),l},t.getTargetsPawnMove=function(e,n){var a=0,r=0,o=0,i=[],s=0,c=0,u="";return a=v.columns.indexOf(e[0])+1,o=Number(e[1]),r=n===v.black?-1:1,s=a,c=o+r,u=v.columns[s-1]+c,t.occupiedSquares.hasOwnProperty(u)?i:(i.push(u),(2===o&&1===r||7===o&&-1===r)&&(c=o+2*r,u=v.columns[s-1]+c,t.occupiedSquares.hasOwnProperty(u)||i.push(u)),i)},t.hasLegalMoves=function(){var e=t.getPiecesPlaces(t.activeColor);return e.some(function(e){var n=t.getLegalSquares(e);return n.length>0})},t.isCheckmate=function(){var e=t.isInCheck(t.activeColor);return e?!t.hasLegalMoves():!1},t.isControlledBy=function(e,n){var a=t.getPiecesPlaces(n);return a.some(function(n){var a=t.getTargets(n,!0);return a.indexOf(e)>-1})},t.isDrawBy50MovesRule=function(){return t.halfmoveClock>99},t.isDrawByInsufficientMaterial=function(){function e(e,t){return e.length!==t.length?!1:e.every(function(e,n){return t[n]===e})}var n=[],a=!1,r=[[v.blackKing,v.blackBishop],[v.blackKing,v.blackKnight],[v.blackKing,v.blackKnight,v.blackKnight]],o=[],i=[];return n=t.getPiecesPlaces(v.black),n.length>3?!1:(i=t.getPiecesPlaces(v.white),i.length>3?!1:n.length>1&&(n.forEach(function(e){var n=t.occupiedSquares[e];o.push(n)}),a=r.some(function(t){return e(t,o)}),!a)?!1:1===i.length?!0:(o=[],i.forEach(function(e){var n=t.occupiedSquares[e];o.push(n.toLowerCase())}),r.some(function(t){return e(t,o)})))},t.isInCheck=function(e){var n="",a="";return n=e===v.white?v.black:v.white,a=t.getKingSquare(e),t.isControlledBy(a,n)},t.initPosition=function(){var a=[];if(!n.isValidFEN(e))throw new Error(p.invalidFEN);a=k.fen.exec(e),t.activeColor=a[1],t.allowedCastles=a[2],t.enPassantSquare=a[3],t.fullmoveNumber=Number(a[5]),t.halfmoveClock=Number(a[4]),t.occupiedSquares=n.fenToObject(e)},t.initPosition(),t}function a(e,t,n){var a={div:null,ghost:null,isAnimated:!1,name:e,square:null,url:t,width:n};return a.animatePut=function(e){b(function(){e.div.appendChild(a.div)})},a.animateRemove=function(){b(function(){var e=a.div.parentElement;e.removeChild(a.div)})},a.fadingPlace=function(e){var t=Number(a.div.style.opacity);0===t&&a.animatePut(e),t+=.05,a.div.style.opacity=t,1!==t&&b(a.fadingPlace)},a.fadingRemove=function(){var e=a.div.style.opacity;""===e&&(e=1),e-=.05,a.div.style.opacity=e,e>0?b(a.fadingRemove):a.animateRemove()},a.getGhostCoordinate=function(){var e=Math.round(a.ghost.getBoundingClientRect().left+window.pageXOffset),t=Math.round(a.ghost.getBoundingClientRect().top+window.pageYOffset);return[e,t]},a.initPiece=function(){var e="url('"+t+"')";a.div=document.createElement("DIV"),a.div.className=h.squarePiece,a.div.style.backgroundImage=e,a.div.addEventListener("mousedown",a.mouseDownHandler),a.ghost=document.createElement("DIV"),a.ghost.className=h.ghostPiece,a.ghost.style.backgroundImage=e},a.mouseDownHandler=function(e){"function"==typeof a.square.board.onPieceMouseDown&&a.square.board.onPieceMouseDown(e,a)},a.put=function(e){e.isEmpty()||e.piece.remove(),e.piece=a,a.square=e},a.remove=function(){null!==a.square&&(a.square.piece=null)},a.setGhostPosition=function(e,t){b(function(){a.ghost.style.left=e+"px",a.ghost.style.top=t+"px"})},a.setGhostPositionCursor=function(e){var t=e.clientX+window.pageXOffset-a.width/2,n=e.clientY+window.pageYOffset-a.width/2;a.setGhostPosition(t,n)},a.showGhost=function(){b(function(){a.div.style.opacity="0",a.ghost.style.height=a.width+"px",a.ghost.style.width=a.width+"px",document.body.appendChild(a.ghost)})},a.initPiece(),a}function r(e,t){var n={board:null,canvas:null,div:null,hasCircle:!1,isHighlighted:!1,isMarked:!1,isOverflown:!1,isSelected:!1,name:e,piece:null,width:t};return n.clickHandler=function(){"function"==typeof n.board.onSquareClick&&n.board.onSquareClick(n.name)},n.drawFilledCircle=function(e){var t=n.canvas.getContext("2d"),a=Math.floor(n.width/8),r=Math.floor(n.width/2);n.canvas.className=h.squareCanvas,n.canvas.setAttribute("height",n.width+"px"),n.canvas.setAttribute("width",n.width+"px"),t.beginPath(),t.arc(r,r,a,0,2*Math.PI),t.fillStyle=e,t.fill()},n.mouseDownHandler=function(e){"function"==typeof n.board.onSquareMouseDown&&n.board.onSquareMouseDown(e)},n.mouseEnterHandler=function(){"function"==typeof n.board.onSquareEnter&&n.board.onSquareEnter(n)},n.mouseLeaveHandler=function(){"function"==typeof n.board.onSquareLeave&&n.board.onSquareLeave(n)},n.mouseUpHandler=function(){"function"==typeof n.board.onSquareMouseUp&&n.board.onSquareMouseUp(n)},n.getClassName=function(){var e=h.square+" ";return e+=r.isWhite(n.name)?h.whiteSquare:h.blackSquare,n.isHighlighted&&(e+=" "+h.highlightedSquare),n.isMarked&&(e+=" "+h.markedSquare),n.isOverflown&&(e+=" "+h.overflownSquare),n.isSelected&&(e+=" "+h.selectedSquare),e},n.getCoordinate=function(){var e=Math.round(n.div.getBoundingClientRect().left+window.pageXOffset),t=Math.round(n.div.getBoundingClientRect().top+window.pageYOffset);return[e,t]},n.highlight=function(){n.isHighlighted=!n.isHighlighted,n.updateClass()},n.initSquare=function(){var t=r.isWhite(e)?h.square+" "+h.whiteSquare:h.square+" "+h.blackSquare,a=document.createElement("DIV");n.canvas=document.createElement("CANVAS"),n.div=a,a.className=t,a.addEventListener("click",n.clickHandler),a.addEventListener("mousedown",n.mouseDownHandler),a.addEventListener("mouseenter",n.mouseEnterHandler),a.addEventListener("mouseleave",n.mouseLeaveHandler),a.addEventListener("mouseup",n.mouseUpHandler)},n.isEmpty=function(){return null===n.piece},n.mark=function(){n.isMarked=!n.isMarked,n.updateClass()},n.overfly=function(){n.isOverflown=!n.isOverflown,n.updateClass()},n.select=function(){n.isSelected=!n.isSelected,n.updateClass()},n.showCanvas=function(){b(n.hasCircle?function(){n.div.removeChild(n.canvas)}:function(){n.div.appendChild(n.canvas)}),n.hasCircle=!n.hasCircle},n.updateClass=function(){var e=n.getClassName();b(function(){n.div.className=e})},n.initSquare(),n}function o(e,t){var o={animationSpeed:t.animationSpeed,clickablePieces:t.clickable,columnsBorder:null,container:null,draggablePieces:t.draggable,imagesExtension:t.imagesExtension,imagesPath:t.imagesPath,hasDraggedClickedSquare:!1,isDragging:!1,isFlipped:t.flipped,legalMarksColor:t.legalMarksColor,markOverflownSquare:t.markOverflownSquare,notationBorder:t.notationBorder,onMouseMove:null,onMouseUp:null,onPieceMouseDown:null,onPromotionChose:null,onSquareClick:null,onSquareEnter:null,onSquareMouseDown:null,onSquareMouseUp:null,onSquareLeave:null,pendingMove:null,promotionDiv:null,rowsBorder:null,selectedSquare:null,squares:{},squaresDiv:null,width:t.width};return o.addNavigationData=function(e,t){Object.keys(o.squares).forEach(function(e){var t=o.squares[e];t.piece=null}),t.forEach(function(e){e.square.piece=e}),e.forEach(function(e){var t=e.arrival,n=e.piece,a=e.start;void 0!==t&&(void 0===a?(t.piece=n,n.square=t):(t.piece=n,n.square=t))})},o.animateGhost=function(e){var t=[],n=e.piece,a=[];return a[0]=e.start[0]+e.vectors[0],a[1]=e.start[1]+e.vectors[1],t[0]=Math.abs(a[0]-e.arrival[0]),t[1]=Math.abs(a[1]-e.arrival[1]),e.instant||t[0]===e.rest[0]&&t[1]===e.rest[1]?(null!==n.ghost.parentElement&&document.body.removeChild(n.ghost),n.div.style.opacity="1",void(n.isAnimated=!1)):(n.setGhostPosition(a[0],a[1]),e.start=a,void b(function(){o.animateGhost(e)}))},o.animateNavigation=function(e){e.forEach(function(e){var t=e.arrival,n={},a=e.piece,r=e.start;void 0===t?a.fadingRemove():void 0===r?a.fadingPlace(t):(n.arrival=t,n.isCapture=!1,n.piece=a,o.movePiece(n,!0))})},o.askPromotion=function(e){for(var t=[v.blackQueen,v.blackRook,v.blackBishop,v.blackKnight],n=o.promotionDiv;n.hasChildNodes();)n.removeChild(n.lastChild);t.forEach(function(t){var a,r=o.imagesPath+e+t+o.imagesExtension;a=document.createElement("INPUT"),a.className=h.promotionButton,a.setAttribute("type","button"),a.setAttribute("name",t),a.style.backgroundImage="url('"+r+"')",a.addEventListener("click",o.clickPromotionHandler),n.appendChild(a)}),o.lock(),b(function(){n.style.display="block"})},o.clearMarks=function(){Object.keys(o.squares).forEach(function(e){var n=o.squares[e];t.markLastMove&&n.isHighlighted&&n.highlight(),t.markKingInCheck&&n.isMarked&&n.mark(),t.markOverflownSquare&&n.isOverflown&&n.overfly(),t.markSelectedSquare&&n.isSelected&&n.select(),t.markLegalSquares&&n.hasCircle&&n.showCanvas()}),f.selectedSquare=null},o.clickPromotionHandler=function(e){var t=e.target.name;"function"==typeof o.onPromotionChose&&o.onPromotionChose(t),o.pendingMove=null,o.unlock(),b(function(){o.promotionDiv.style.display="none"})},o.createBoard=function(){var e=v.columns.split(""),t=v.rows.split("");o.squaresDiv=document.createElement("DIV"),o.squaresDiv.style.width=o.width+"px",o.squaresDiv.style.height=o.width+"px",o.squaresDiv.className=h.squaresDiv,o.isFlipped?e=e.reverse():t=t.reverse(),t.forEach(function(t){e.forEach(function(e){var n=o.squares[e+t];o.squaresDiv.appendChild(n.div)})})},o.createColumnsBorder=function(){var e=v.columns.split("");o.columnsBorder=document.createElement("DIV"),o.columnsBorder.className=h.columnsBorder,o.columnsBorder.style.width=o.width+"px",o.isFlipped&&(e=e.reverse()),e.forEach(function(e){var t=document.createElement("DIV");t.className=h.columnsBorderFragment,t.innerHTML=e,o.columnsBorder.appendChild(t)})},o.createRowsBorder=function(){var e=Math.floor(o.width/8)+"px",t=v.rows.split("");o.rowsBorder=document.createElement("DIV"),o.rowsBorder.className=h.rowsBorder,o.rowsBorder.style.height=o.width+"px",o.isFlipped||(t=t.reverse()),t.forEach(function(t){var n=document.createElement("DIV");n.className=h.rowsBorderFragment,n.style.lineHeight=e,n.innerHTML=t,o.rowsBorder.appendChild(n)})},o.createSquares=function(){var e=v.columns.split(""),t=v.rows.split(""),n=Math.floor(o.width/8);e.forEach(function(e){t.forEach(function(t){var a=e+t,i=new r(a,n);i.drawFilledCircle(o.legalMarksColor),i.board=o,o.squares[a]=i})})},o.displayCanvas=function(e){e.forEach(function(e){var t=o.squares[e];t.showCanvas()})},o.draw=function(){o.promotionDiv=document.createElement("DIV"),o.promotionDiv.className=h.promotionDiv,o.createBoard(),b(function(){o.squaresDiv.appendChild(o.promotionDiv),o.container.appendChild(o.squaresDiv)}),o.notationBorder&&(o.createRowsBorder(),b(function(){o.container.insertBefore(o.rowsBorder,o.squaresDiv)}),o.createColumnsBorder(),b(function(){o.container.appendChild(o.columnsBorder)}))},o.empty=function(){Object.keys(o.squares).forEach(function(e){var t=o.squares[e];t.isEmpty()||(t.piece.animateRemove(),t.piece.remove())})},o.getAnimations=function(e){var t=[],n=e.occupiedSquares,a=[],r=[],i=o.getPositionObject();return Object.keys(i).forEach(function(e){n[e]!==i[e]&&r.push(e)}),Object.keys(n).forEach(function(e){var s=!1,c=0;i[e]!==n[e]&&(s=r.some(function(a,r){var s={},u={},l={},g={};return n[e]!==i[a]?!1:(g=o.squares[a],u=o.squares[e],l=g.piece,s.start=g,s.arrival=u,s.piece=l,t.push(s),c=r,!0)}),s?r.splice(c,1):a.push(e))}),r.forEach(function(e){var n={},a={},r=o.squares[e];a=r.piece,n.start=r,n.piece=a,t.push(n)}),a.forEach(function(e){var a={},r=o.squares[e],i=n[e];a.arrival=r,a.piece=o.getNewPiece(i),t.push(a)}),t},o.getNewPiece=function(e){var t=e.toLowerCase()===e?v.black+e:v.white+e.toLowerCase(),n=o.imagesPath+t+o.imagesExtension,r=Math.floor(f.width/8);return new a(t,n,r)},o.getPositionObject=function(){var e={};return Object.keys(o.squares).forEach(function(t){var n="",a="",r=o.squares[t];r.isEmpty()||(a=r.piece.name,n=a[0]===v.white?a[1].toUpperCase():a[1].toLowerCase(),e[t]=n)}),e},o.getSimilarPieces=function(e){var t=e.occupiedSquares,n=o.getPositionObject(),a=[];return Object.keys(t).forEach(function(e){var r=t[e],i=n[e],s={};i===r&&(s=o.squares[e].piece,a.push(s))}),a},o.highlightSquares=function(e){e.forEach(function(e){o.squares[e].highlight()})},o.initBoard=function(){switch(o.container=document.getElementById(e),o.animationSpeed){case"slow":o.animationSpeed=20;break;case"normal":o.animationSpeed=10;break;case"fast":o.animationSpeed=5;break;case"instant":o.animationSpeed=1/0;break;default:o.animationSpeed=10}},o.loadFEN=function(e){var t={};if(e=e||v.defaultFEN,!n.isValidFEN(e,!0))throw new SyntaxError(p.invalidFEN);o.empty(),t=n.fenToObject(e),Object.keys(t).forEach(function(e){var n=t[e],a=o.getNewPiece(n),r=o.squares[e];a.animatePut(r),a.put(r)})},o.lock=function(){o.clickablePieces=!1,o.draggablePieces=!1},o.markSquares=function(e){e.forEach(function(e){o.squares[e].mark()})},o.movePiece=function(e,t){var n=e.arrival.getCoordinate(),a={},r=e.piece.square.getCoordinate();e.isCapture&&(a=e.arrival.piece),t&&(e.piece.setGhostPosition(r[0],r[1]),e.piece.showGhost(),o.startGhostAnimation(e.piece,r,n)),e.isCapture&&a.fadingRemove(),e.piece.animateRemove(),e.piece.animatePut(e.arrival)},o.play=function(e,t,n){var a="",r={},i=!1,s={},c={},u=e.substr(0,2),l=o.squares[u];if(l.isEmpty())throw new Error(p.illegalMove);return c=l.piece,a=e.substr(3,2),r=o.squares[a],i=r.isEmpty(),s.arrival=r,s.isCapture=!i,s.piece=c,o.movePiece(s,n),c.remove(),c.put(r),k.castle.test(e)&&c.name[1]===v.blackKing?void o.playCastle(a):void(c.name[1]===v.blackPawn&&(i&&k.enPassant.test(e)&&u[0]!==a[0]?o.playEnPassant(a):k.promotion.test(e)&&o.playPromotion(c,a,t)))},o.playCastle=function(e){var t={},n={},a="",r="";if(e[0]===v.columns[2]?(a=v.columns[3]+e[1],r=v.columns[0]+e[1]):e[0]===v.columns[6]&&(a=v.columns[5]+e[1],r=v.columns[7]+e[1]),o.squares[r].isEmpty())throw new Error(p.illegalMove);n=o.squares[r].piece,t.arrival=o.squares[a],t.isCapture=!1,t.piece=n,o.movePiece(t,!0),n.remove(),n.put(o.squares[a])},o.playEnPassant=function(e){var t="",n={};switch(t=e[0],e[1]){case"3":t+="4";break;case"6":t+="5"}if(n=o.squares[t],n.isEmpty())throw new Error(p.illegalMove);n.piece.fadingRemove(),n.piece.remove()},o.playPromotion=function(e,t,n){var r=o.squares[t],i={},s="",c="",u="",l=Math.floor(f.width/8);n=n||v.blackQueen,s=t[1]===v.rows[0]?v.black:v.white,c=s+n.toLowerCase(),u=o.imagesPath+c+o.imagesExtension,i=new a(c,u,l),e.fadingRemove(),e.remove(),i.fadingPlace(r),i.put(r)},o.startGhostAnimation=function(e,t,n){var a={},r=[],i=[],s=[],c=o.animationSpeed,u=[];r[0]=Math.abs(t[0]-n[0]),r[1]=Math.abs(t[1]-n[1]),Math.max(r[0],r[1])<c?a.instant=!0:r.forEach(function(e,a){i[a]=e%c,s[a]=t[a]<n[a]?1:-1,u[a]=s[a]*(e-i[a])/c}),a.arrival=n,a.piece=e,a.rest=i,a.start=t,a.vectors=u,e.isAnimated=!0,b(function(){o.animateGhost(a)})},o.unlock=function(){o.clickablePieces=t.clickable,o.draggablePieces=t.draggable},o.initBoard(),o}function i(){var e={comments:[],fenStrings:[v.defaultFEN],moves:[],pgnMoves:[],tags:{}};return e.addMove=function(t,n){var a=e.fenStrings.length-1,r=e.getNthPosition(a),o={};n=n||"",o=r.getNextPosition(t,n),e.fenStrings.push(o.fenString),e.setResult(o),e.moves.push(t),e.pgnMoves.push(r.getPGNMove(t,n))},e.exportPGN=function(){var t=0,n="\n",a=80,r="";return Object.keys(e.tags).forEach(function(t){var a=e.tags[t];r+="["+t+' "'+a+'"]'+n}),r+=n,e.pgnMoves.forEach(function(e,o){var i="";0!==t&&(i=" "),o%2===0&&(i+=o/2+1+". "),i+=e,t+=i.length,t>=a&&(r+=n,t=i.length),r+=i}),r+" "+e.getInfo("Result")+n+n},e.getInfo=function(t){return e.tags[t]},e.getNthPosition=function(t){var a="",r=0;if(r=e.fenStrings.length-1,"number"!=typeof t||0>t||t>r)throw new Error(p.invalidParameter);return a=e.fenStrings[t],new n(a)},e.importMoves=function(){var t={};e.fenStrings=[v.defaultFEN],e.moves=[],t=e.getNthPosition(0),e.pgnMoves.forEach(function(n){var a=t.getSimpleMove(n),r={},o="";a.indexOf(v.promotionSymbol)>-1&&(o=a[a.length-1],a=a.replace(k.pgnPromotion,"")),e.moves.push(a),r=t.getNextPosition(a,o),e.fenStrings.push(r.fenString),t=r})},e.importPGNMoves=function(t){var n=[];for(e.pgnMoves=[];k.comment.test(t);)t=t.replace(k.comment,"");for(;k.variation.test(t);)t=t.replace(k.variation,"");t=t.replace(/\s{2,}/gm," "),n=t.match(k.pgnMove),n.forEach(function(t){t=t.replace(k.pgnMoveNumber,""),e.pgnMoves.push(t)})},e.importTags=function(t){var n=t.match(k.tagPair);e.tags={},e.initRequiredTags(),n.forEach(function(t){var n=k.tagPairCapture.exec(t);e.setTag(n[1],n[2])})},e.initRequiredTags=function(){var t={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"};Object.keys(t).forEach(function(n){e.tags[n]=t[n]})},e.isInCheck=function(t){var n="",a={};return a=e.getNthPosition(t),n=a.activeColor,a.isInCheck(n)},e.isLegal=function(t,n){var a=e.getNthPosition(t);return a.checkMoveLegality(n)},e.setPGN=function(t){if(!i.isValidPGN(t))throw new SyntaxError(p.invalidPGN);e.importTags(t),e.importPGNMoves(t),e.importMoves()},e.setResult=function(t){var n=!t.hasLegalMoves(),a=!1,r="*";n?(a=t.isInCheck(t.activeColor),r=a?t.activeColor===v.black?v.resultWhite:v.resultBlack:v.resultDraw):(t.isDrawByInsufficientMaterial()||t.isDrawBy50MovesRule())&&(r=v.resultDraw),e.setTag("Result",r)},e.setTag=function(t,n){e.tags[t]=n},e.initRequiredTags(),e}function s(e,n){var a="",r="",o="",i="";f.clearMarks(),t.markLastMove&&e>0&&(r=d.moves[e-1],i=r.substr(0,2),o=r.substr(3,2),f.highlightSquares([i,o])),t.markKingInCheck&&n.isInCheck(n.activeColor)&&(a=n.getKingSquare(n.activeColor),f.markSquares([a]))}function c(e,t){var n=[],a=0,r={},o=[];if(a=d.fenStrings.length-1,0>e||e>a)throw new Error(p.invalidParameter);r=d.getNthPosition(e),s(e,r),t&&(n=f.getAnimations(r),o=f.getSimilarPieces(r),f.animateNavigation(n),f.addNavigationData(n,o),a>e?f.lock():f.unlock())}function u(e){var n={},a=[],r=0;null===f.selectedSquare?f.selectedSquare=e:f.selectedSquare=null,t.markSelectedSquare&&f.squares[e].select(),t.markLegalSquares&&(r=d.fenStrings.length-1,n=d.getNthPosition(r),a=n.getLegalSquares(e),f.displayCanvas(a))}function l(e,t,n){var a={},r=d.fenStrings.length-1;if(a=d.getNthPosition(r),!a.checkMoveLegality(e))throw new Error(p.illegalMove);f.play(e,t,n),d.addMove(e,t),c(r+1,!1),"function"==typeof w.onMovePlayed&&b(w.onMovePlayed)}function g(e,t,n){var a="",r="",o=0,i="",s={};if(r=e+"-"+t,!k.move.test(r))throw new Error(p.invalidParameter);return o=d.fenStrings.length-1,d.isLegal(o,r)?(s=d.getNthPosition(o),i=s.occupiedSquares[e],i.toLowerCase()===v.blackPawn&&k.promotion.test(r)?(f.pendingMove=r,a="8"===t[1]?v.white:v.black,f.askPromotion(a)):l(r,"",n),!0):!1}var f={},d={},v={bishopVectors:[[-1,-1],[-1,1],[1,-1],[1,1]],black:"b",blackBishop:"b",blackKing:"k",blackKnight:"n",blackPawn:"p",blackQueen:"q",blackRook:"r",captureSymbol:"x",castleKingSymbol:"O-O",castleQueenSymbol:"O-O-O",checkSymbol:"+",checkmateSymbol:"#",columns:"abcdefgh",defaultFEN:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",kingVectors:[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],knightVectors:[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],promotionSymbol:"=",resultBlack:"0-1",resultDraw:"1/2-1/2",resultWhite:"1-0",rookVectors:[[-1,0],[0,-1],[0,1],[1,0]],rows:"12345678",white:"w",whiteBishop:"B",whiteKing:"K",whiteKnight:"N",whitePawn:"P",whiteQueen:"Q",whiteRook:"R"},h={blackSquare:"square_black",columnsBorder:"columns-border",columnsBorderFragment:"columns-border__fragment",ghostPiece:"ghost_piece",highlightedSquare:"square_highlighted",markedSquare:"square_marked",overflownSquare:"square_overflown",promotionButton:"promotion-button",promotionDiv:"promotion-div",rowsBorder:"rows-border",rowsBorderFragment:"rows-border__fragment",selectedSquare:"square_selected",square:"square",squareCanvas:"square__canvas",squarePiece:"square__piece",squaresDiv:"squares-div",whiteSquare:"square_white"},m={animationSpeed:"normal",clickable:!0,draggable:!0,flipped:!1,imagesExtension:".png",imagesPath:"images/wikipedia/",legalMarksColor:"steelblue",markKingInCheck:!0,markLastMove:!0,markLegalSquares:!0,markOverflownSquare:!0,markSelectedSquare:!0,notationBorder:!0,width:360},p={illegalMove:"Illegal move.",invalidFEN:"Invalid FEN string.",invalidParameter:"Invalid parameter.",invalidPGN:"Invalid PGN."},w={onMovePlayed:null},k={castle:/^e(?:1-c1|1-g1|8-c8|8-g8)$/,comment:/\{[^]+?\}/gm,enPassant:/^[a-h]4-[a-h]3|[a-h]5-[a-h]6$/,fen:/^(?:[bBkKnNpPqQrR1-8]{1,8}\/){7}[bBkKnNpPqQrR1-8]{1,8}\s(w|b)\s(KQ?k?q?|K?Qk?q?|K?Q?kq?|K?Q?k?q|-)\s([a-h][36]|-)\s(0|[1-9]\d*)\s([1-9]\d*)$/,fenRow:/^[bknpqr1]{8}|[bknpqr12]{7}|[bknpqr1-3]{6}|[bknpqr1-4]{5}|[bknpqr1-5]{4}|[bknpqr1-6]{3}|[bknpqr]7|7[bknpqr]|8$/i,move:/^[a-h][1-8]-[a-h][1-8]$/,pgnCastle:/^O-O(?:-O)?(?:\+|#)?$/,pgnKingMove:/^(?:Kx?([a-h][1-8])|O-O(?:-O)?)(?:\+|#)?$/,pgnMove:/(?:[1-9][0-9]*\.(?:\.\.)?\s*)?(?:O-O(?:-O)?|(?:[BNQR][a-h]?[1-8]?|K)x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:\=[BNQR])?)(?:\+|#)?/gm,pgnMoveNumber:/[1-9][0-9]*\.(?:\.\.)?\s?/,pgnPawnMove:/^([a-h]?)x?([a-h][1-8])(\=[BNQR])?(?:\+|#)?$/,pgnPieceMove:/^[BNQR]([a-h]?[1-8]?)x?([a-h][1-8])(?:\+|#)?$/,pgnPromotion:/\=[BNQR]$/,pgnShortMove:/^(?:O-O(?:-O)?|(?:[BNQR][a-h]?[1-8]?|K)x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:\=[BNQR])?)(?:\+|#)?$/,pieceChar:/[bknpqr]/i,promotion:/^[a-h]2-[a-h]1|[a-h]7-[a-h]8$/,result:/1-0|0-1|1\/2-1\/2|\*/,row:/[1-8]/,tagPair:/\[[A-Z][^]+?\s"[^]+?"\]/gm,tagPairCapture:/\[(\S+)\s"(.*)"/,tagPairsSection:/(?:\[[^]+?\s"[^]+?"\]\s+){7,}\s+/gm,variation:/\([^()]*?\)/gm},b=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)};return n.fenToObject=function(e){var t={},n="",a=[];return n=e.replace(/\s.*/,""),a=n.split("/"),a.forEach(function(e,n){var a=1,r=8-n;e.split("").forEach(function(e){var n="";if(k.pieceChar.test(e))n=v.columns[a-1]+r,t[n]=e,a+=1;else{if(!k.row.test(e))throw new Error(p.invalidFEN);a+=Number(e)}})}),t},n.isValidFEN=function(e,t){var n=e.replace(/\s.*/,"").split("/");return t=t||!1,t||k.fen.test(e)?n.every(function(e){return k.fenRow.test(e)}):!1},n.objectToFEN=function(e){var t=v.columns.split(""),n="",a=v.rows.split("").reverse();return a.forEach(function(a,r){var o=0;t.forEach(function(t,i){e.hasOwnProperty(t+a)?(o>0&&(n+=o,o=0),n+=e[t+a]):o+=1,7>i||(o>0&&(n+=o),7>r&&(n+="/"))})}),n},r.isWhite=function(e){var t=0,n=0;return t=v.columns.indexOf(e[0])+1,n=Number(e[1]),n%2===0?t%2===1:t%2===0},i.isValidPGN=function(e){function t(e){return k.pgnMove.test(e)}var n=[],a=[];if(!k.tagPairsSection.test(e))return!1;for(e=e.replace(k.tagPairsSection,"");k.comment.test(e);)e=e.replace(k.comment,"");for(;k.variation.test(e);){if(a=e.match(k.variation),!a.every(t))return!1;e=e.replace(k.variation,"")}return n=e.match(k.pgnMove),n.length<1?!1:(e=e.replace(k.pgnMove,""),k.result.test(e))},t=t||{},Object.keys(m).forEach(function(e){t.hasOwnProperty(e)||(t[e]=m[e])}),f=new o(e,t),d=new i,f.onMouseMove=function(e){var t={};f.isDragging&&(t=f.squares[f.selectedSquare],t.piece.setGhostPositionCursor(e))},f.onMouseUp=function(){var e=[],t={},n=[];f.isDragging&&(t=f.squares[f.selectedSquare],e=t.piece.getGhostCoordinate(),n=t.getCoordinate(),f.startGhostAnimation(t.piece,e,n),null!==f.selectedSquare&&u(f.selectedSquare),f.isDragging=!1)},f.onPieceMouseDown=function(e,t){if(e.preventDefault(),f.draggablePieces&&!t.isAnimated&&0===e.button){if(f.isDragging=!0,t.setGhostPositionCursor(e),t.showGhost(),f.markOverflownSquare&&t.square.overfly(),f.selectedSquare===t.square.name)return void(f.hasDraggedClickedSquare=!0);null!==f.selectedSquare&&u(f.selectedSquare),u(t.square.name)}},f.onPromotionChose=function(e){var t=f.pendingMove;l(t,e,!0)},f.onSquareClick=function(e){var t=f.squares[e].isEmpty(),n=f.selectedSquare;if(f.clickablePieces){if(e===n)return void u(n);null===n?t||f.hasDraggedClickedSquare||u(e):(u(n),g(n,e,!0)||t||u(e)),f.hasDraggedClickedSquare=!1}},f.onSquareEnter=function(e){f.isDragging&&f.markOverflownSquare&&e.overfly()},f.onSquareLeave=function(e){f.isDragging&&f.markOverflownSquare&&e.overfly()},f.onSquareMouseDown=function(e){e.preventDefault()},f.onSquareMouseUp=function(e){var t=[],n=[],a={},r={};f.isDragging&&(f.markOverflownSquare&&e.overfly(),r=f.squares[f.selectedSquare],u(r.name),a=r.piece,n=r.piece.getGhostCoordinate(),t=e.name!==r.name&&g(r.name,e.name,!1)?e.getCoordinate():r.getCoordinate(),
f.startGhostAnimation(a,n,t),f.isDragging=!1)},document.addEventListener("mousemove",f.onMouseMove),document.addEventListener("mouseup",f.onMouseUp),{DEFAULT_FEN:v.defaultFEN,draw:function(){f.createSquares(),f.draw()},flip:function(){var e=f.container;for(f.isFlipped=!f.isFlipped;e.hasChildNodes();)e.removeChild(e.lastChild);f.draw()},getActiveColor:function(e){var t={};return t=d.getNthPosition(e),t.activeColor},getFEN:function(e){var t=0;if(t=d.fenStrings.length-1,"number"!=typeof e||0>e||e>t)throw new Error(p.invalidParameter);return d.fenStrings[e]},getGameInfo:function(e){return d.getInfo(e)},getGameMoves:function(){return d.moves},getGameMovesPGN:function(){return d.pgnMoves},getLastPositionIndex:function(){return d.fenStrings.length-1},getLegalMoves:function(e){var t={};return t=d.getNthPosition(e),t.getLegalMoves()},getPGN:function(){return d.exportPGN()},is50MovesDraw:function(e){var t={};return t=d.getNthPosition(e),t.isDrawBy50MovesRule()},isCheckmate:function(e){var t={};return t=d.getNthPosition(e),t.isCheckmate()},isInCheck:function(e){return d.isInCheck(e)},isInsufficientMaterialDraw:function(e){var t={};return t=d.getNthPosition(e),t.isDrawByInsufficientMaterial()},isLegal:function(e,t){if(!k.move.test(t))throw new SyntaxError(p.invalidParameter);return d.isLegal(e,t)},isStalemate:function(e){var t="",n=d.getNthPosition(e);return t=n.activeColor,!n.isInCheck(t)&&!n.hasLegalMoves()},isValidFEN:function(e,t){return n.isValidFEN(e,t)},isValidPGN:function(e){return i.isValidPGN(e)},navigate:function(e){return c(e,!0)},onMovePlayed:function(e){if("function"!=typeof e)throw new Error(p.invalidParameter);w.onMovePlayed=e},play:function(e,t){if(!k.move.test(e))throw new SyntaxError(p.invalidParameter);return l(e,t,!0)},reset:function(){f.loadFEN(),f.clearMarks(),f.unlock(),d=new i},setFEN:function(e){f.loadFEN(e)},setGameInfo:function(e,t){return d.setTag(e,t)},setPGN:function(e){d.setPGN(e)}}};