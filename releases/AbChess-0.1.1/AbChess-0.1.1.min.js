window.AbChess=window.AbChess||function(e,t){"use strict";function r(e){var t="",n="",a="",i=[],o=0,s=0,c={},l={};if(!r.isValidFEN(e))throw new Error(m.invalid_fen);return i=q.exec(e),t=i[1],n=i[2],a=i[3],o=Number(i[5]),s=Number(i[4]),c=r.fenToObject(e),l={activeColor:t,allowedCastles:n,enPassantSquare:a,fenString:e,fullmoveNumber:o,halfmoveClock:s,occupiedSquares:c},l.checkMoveLegality=function(e){var r="",n="",a="",i=[],o={};return y.test(e)?(a=e.substr(0,2),c.hasOwnProperty(a)?(n=c[a]===c[a].toLowerCase()?h.black:h.white,t!==n?!1:(o=l.getNextPosition(e),o.isInCheck(t)?!1:(i=l.getTargets(a,!1),r=e.substr(3,2),i.some(function(e){return e===r})))):!1):!1},l.getKingSquare=function(e){var t="",r="";return t=e===h.black?h.black_king:h.white_king,Object.keys(c).every(function(e){var n=c[e];return n===t?(r=e,!1):!0}),r},l.getLegalMoves=function(){var e=[],r=[];return r=l.getPiecesPlaces(t),r.forEach(function(t){var r=l.getLegalSquares(t);r.forEach(function(r){var n=t+"-"+r;e.push(n)})}),e},l.getLegalSquares=function(e){var t=[],r=[];return r=l.getTargets(e,!1),r.forEach(function(r){var n=e+"-"+r;l.checkMoveLegality(n)&&t.push(r)}),t},l.getNextActiveColor=function(){var e="";return e=l.activeColor===h.white?h.black:h.white},l.getNextAllowedCastles=function(e){var t="",r="",a="",i="";if(!y.test(e))throw new SyntaxError(m.invalid_parameter);return"-"===n?n:(r=n,i=e.substr(0,2),a=c[i],t=e.substr(3,2),-1!==n.search(/[kq]/)&&(a===h.black_king&&(r=n.replace(/[kq]/g,"")),("a8"===i||"a8"===t)&&(r=n.replace(/q/,"")),("h8"===i||"h8"===t)&&(r=n.replace(/k/,""))),-1!==n.search(/[KQ]/)&&(a===h.white_king&&(r=n.replace(/[KQ]/g,"")),("a1"===i||"a1"===t)&&(r=n.replace(/Q/,"")),("h1"===i||"h1"===t)&&(r=n.replace(/K/,""))),""===r&&(r="-"),r)},l.getNextEnPassant=function(e){var t=0,r="",n="-",a="",i=0,o="";if(!y.test(e))throw new SyntaxError(m.invalid_parameter);return r=e.substr(3,2),t=Number(r[1]),o=e.substr(0,2),i=Number(o[1]),a=c[o],(a===h.black_pawn||a===h.white_pawn)&&(t-i===2&&(n=o[0]+"3"),i-t===2&&(n=o[0]+"6")),n},l.getNextFullmoveNumber=function(){var e=0;return e=l.activeColor===h.black?o+1:o},l.getNextHalfmoveClock=function(e){var t="",r="",n=0,a="",i=!1;if(!y.test(e))throw new SyntaxError(m.invalid_parameter);return a=e.substr(0,2),r=c[a],t=e.substr(3,2),i=c.hasOwnProperty(t),n=r===h.black_pawn||r===h.white_pawn||i?0:s+1},l.getNextPosition=function(e,t){var n="",i="",o="",s="",c="",u="",f=0,g=0,v={},p="",b="",w="",q="",P="";if(!y.test(e))throw new SyntaxError(m.invalid_parameter);return v=r.fenToObject(l.fenString),P=e.substr(0,2),p=v[P],n=e.substr(3,2),p.toLowerCase()===h.black_king&&k.test(e)?(q=n[0]===d[2]?d[0]+n[1]:d[7]+n[1],w=n[0]===d[2]?d[3]+n[1]:d[5]+n[1],delete v[q],"e1"===P?v[w]=h.white_rook:v[w]=h.black_rook):p.toLowerCase()===h.black_pawn&&(n===a&&_.test(e)&&(i=a[0]+P[1],delete v[i]),C.test(e)&&(t=t||h.black_queen,"1"===n[1]&&(p=t.toLowerCase()),"8"===n[1]&&(p=t.toUpperCase()))),delete v[P],v[n]=p,b=r.objectToFEN(v),o=l.getNextActiveColor(),s=l.getNextAllowedCastles(e),c=l.getNextEnPassant(e),g=l.getNextHalfmoveClock(e),f=l.getNextFullmoveNumber(),u=b+" "+o+" "+s+" "+c+" "+g+" "+f,new r(u)},l.getPGNMove=function(e,r,n,i){var s=!1,u=!1,f="",g="",v=!1,p=!1,b="",w="",_="";if(!y.test(e))throw new SyntaxError(m.invalid_parameter);if(n&&(b=t===h.white?o+". ":o+"... "),_=e.substr(0,2),w=c[_],f=e.substr(3,2),k.test(e))b+=f[0]===d[2]?h.castle_queen_symbol:h.castle_king_symbol;else{switch(v=c.hasOwnProperty(f),w.toLowerCase()){case h.black_bishop:case h.black_king:case h.black_knight:case h.black_queen:case h.black_rook:b+=w.toUpperCase();break;case h.black_pawn:(v||f===a)&&(b+=_[0],v=!0),p=C.test(e)}w.toLowerCase()!==h.black_pawn&&w.toLowerCase()!==h.black_king&&(Object.keys(c).forEach(function(e){var t=[],r="";s&&u||(r=c[e],r===w&&e!==_&&(t=l.getLegalSquares(e),-1!==t.indexOf(f)&&(e[0]===_[0]?s=!0:e[1]===_[1]?u=!0:g=_[0])))}),s&&(g+=_[1]),u&&(g+=_[0]),b+=g),v&&(b+=h.capture_symbol),b+=f,p&&(b+=h.promotion_symbol+r.toUpperCase())}return i=i||"",b+=i},l.getPiecesPlaces=function(e){var t=[];return Object.keys(c).forEach(function(r){var n=c[r];(e===h.white&&n===n.toUpperCase()||e===h.black&&n===n.toLowerCase())&&t.push(r)}),t},l.getSimpleNotation=function(e){var r="",n="",a=[],i="",o="",s=/^(Kx?([a-h][1-8])|O-O(?:-O)?)(?:\+|#)?$/,u=/^([a-h]?)x?([a-h][1-8])(\=[BNQR])?(?:\+|#)?$/,f=/^[BNQR]([a-h]?[1-8]?)x?([a-h][1-8])(?:\+|#)?$/,g=0,d=[],v="";if(s.test(e)){if(a=s.exec(e),a[1]===h.castle_king_symbol||a[1]===h.castle_queen_symbol)return g=t===h.black?8:1,v="e"+g,n=a[1]===h.castle_king_symbol?"g"+g:"c"+g,v+"-"+n;i=h.white_king,n=a[2]}else if(u.test(e))i=h.white_pawn,a=u.exec(e),r=a[1],n=a[2],-1!==e.indexOf(h.promotion_symbol)&&(o=a[3]);else{if(!f.test(e))throw new SyntaxError(m.invalid_parameter);i=e[0],a=f.exec(e),r=a[1],n=a[2]}return d=l.getPiecesPlaces(t),d=d.filter(function(e){var t=c[e];return t.toLowerCase()===i.toLowerCase()}),d=d.filter(function(e){var t=[];return t=l.getLegalSquares(e),-1!==t.indexOf(n)}),v=d.length>1?d.find(function(e){return-1!==e.indexOf(r)}):d[0],v+"-"+n+o},l.getTargets=function(e,t){var r="",n="",a=[];if(!c.hasOwnProperty(e))return a;switch(n=c[e],r=n.toLowerCase()===n?h.black:h.white,n){case h.black_bishop:case h.white_bishop:a=l.getTargets_bishop(e,r);break;case h.black_king:case h.white_king:a=l.getTargets_kingFull(e,r,t);break;case h.black_knight:case h.white_knight:a=l.getTargets_knight(e,r);break;case h.black_pawn:case h.white_pawn:a=l.getTargets_pawn(e,r,t);break;case h.black_queen:case h.white_queen:a=l.getTargets_queen(e,r);break;case h.black_rook:case h.white_rook:a=l.getTargets_rook(e,r)}return a},l.getTargets_bishop=function(e,t){var r=[],n=0,a="",i=[],o=0,s=[],c=0,u=0,f="";for(n=d.indexOf(e[0])+1,c=n+1,o=Number(e[1]),u=o+1,r=l.getPiecesPlaces(t),a=t===h.black?h.white:h.black,i=l.getPiecesPlaces(a);9>c&&9>u&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)c+=1,u+=1;for(c=n-1,u=o-1;c>0&&u>0&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)c-=1,u-=1;for(c=n+1,u=o-1;9>c&&u>0&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)c+=1,u-=1;for(c=n-1,u=o+1;c>0&&9>u&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)c-=1,u+=1;return s},l.getTargets_king=function(e,t){var r=[],n=[-1,0,1],a=0,i=[-1,0,1],o=0,s=[],c=0,u=0,f="";return r=l.getPiecesPlaces(t),a=d.indexOf(e[0])+1,o=Number(e[1]),n.forEach(function(e){i.forEach(function(t){(0!==e||0!==t)&&(c=a+e,u=o+t,c>0&&9>c&&u>0&&9>u&&(f=d[c-1]+u,-1===r.indexOf(f)&&s.push(f)))})}),s},l.getTargets_kingFull=function(e,t,r){var a="",i="",o=[],s=["f","g"],u=[],f=["b","c","d"],g=[],d="";return u=l.getTargets_king(e,t),a=t===h.black?h.white:h.black,i=l.getKingSquare(a),o=l.getTargets_king(i,a),g=u.filter(function(e){return-1===o.indexOf(e)}),r?g:("e1"!==e||l.isControlledBy("e1",h.black)?"e8"!==e||l.isControlledBy("e8",h.white)||(-1===n.indexOf(h.black_queen)||l.isControlledBy("d8",h.white)||f.every(function(e){return d=e+"8",!c.hasOwnProperty(d)})&&g.push("c8"),-1===n.indexOf(h.black_king)||l.isControlledBy("f8",h.white)||s.every(function(e){return d=e+"8",!c.hasOwnProperty(d)})&&g.push("g8")):(-1===n.indexOf(h.white_queen)||l.isControlledBy("d1",h.black)||f.every(function(e){return d=e+"1",!c.hasOwnProperty(d)})&&g.push("c1"),-1===n.indexOf(h.white_king)||l.isControlledBy("f1",h.black)||s.every(function(e){return d=e+"1",!c.hasOwnProperty(d)})&&g.push("g1")),g)},l.getTargets_knight=function(e,t){var r=[],n=[-2,-1,1,2],a=0,i=[-2,-1,1,2],o=0,s=[],c=0,u=0,f="";return r=l.getPiecesPlaces(t),a=d.indexOf(e[0])+1,o=Number(e[1]),n.forEach(function(e){i.forEach(function(t){Math.abs(e)!==Math.abs(t)&&(c=a+e,u=o+t,c>0&&9>c&&u>0&&9>u&&(f=d[c-1]+u,-1===r.indexOf(f)&&s.push(f)))})}),s},l.getTargets_pawn=function(e,t,r){var n=[],i=[-1,1],o=0,s=0,c="",u=[],f=0,g=[],v=0,p=0,m="";return o=d.indexOf(e[0])+1,f=Number(e[1]),s=t===h.black?-1:1,p=f+s,c=t===h.black?h.white:h.black,u=l.getPiecesPlaces(c),i.forEach(function(e){v=o+e,m=d[v-1]+p,-1!==u.indexOf(m)||a===m?g.push(m):r&&g.push(m)}),r||(v=o,m=d[v-1]+p,n=l.getPiecesPlaces(t),-1===n.indexOf(m)&&-1===u.indexOf(m)&&(g.push(m),(2===f&&1===s||7===f&&-1===s)&&(p=f+2*s,m=d[v-1]+p,-1===n.indexOf(m)&&-1===u.indexOf(m)&&g.push(m)))),g},l.getTargets_queen=function(e,t){return l.getTargets_bishop(e,t).concat(l.getTargets_rook(e,t))},l.getTargets_rook=function(e,t){var r=[],n=0,a="",i=[],o=0,s=[],c=0,u=0,f="";for(n=d.indexOf(e[0])+1,c=n+1,o=Number(e[1]),u=o,r=l.getPiecesPlaces(t),a=t===h.black?h.white:h.black,i=l.getPiecesPlaces(a);9>c&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)c+=1;for(c=n-1;c>0&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)c-=1;for(c=n,u=o+1;9>u&&(f=d[c-1]+u,-1===r.indexOf(f))&&(s.push(f),-1===i.indexOf(f));)u+=1;for(u=o-1;u>0&&(f=d[c-1]+u,!(r.indexOf(f)>-1))&&(s.push(f),!(i.indexOf(f)>-1));)u-=1;return s},l.hasLegalMoves=function(){var e=[];return e=l.getPiecesPlaces(t),e.some(function(e){var t=[];return t=l.getLegalSquares(e),t.length>0})},l.isCheckmate=function(){var e=!1;return e=l.isInCheck(t),e?!l.hasLegalMoves():!1},l.isControlledBy=function(e,t){var r=[];return r=l.getPiecesPlaces(t),r.some(function(t){var r=l.getTargets(t,!0);return r.indexOf(e)>-1})},l.isDrawBy50MovesRule=function(){return s>99},l.isDrawByInsufficientMaterial=function(){var e=[],t=[],r=[],n=[["b"],["n"],["n","n"]],a=!1;return e=l.getPiecesPlaces(h.black),e.length>3?!1:e.length>1&&(e.forEach(function(e){var r=c[e];r!==h.black_king&&t.push(r)}),a=n.some(function(e){var r=!1;return e.length!==t.length?!1:r=e.every(function(e,r){return t[r]===e})}),!a)?!1:(r=l.getPiecesPlaces(h.white),r.length>3?!1:1===r.length?!0:(t=[],r.forEach(function(e){var r=c[e];r!==h.white_king&&t.push(r.toLowerCase())}),a=n.some(function(e){var r=!1;return e.length!==t.length?!1:r=e.every(function(e,r){return t[r]===e})})))},l.isInCheck=function(e){var t="",r="";return t=e===h.white?h.black:h.white,r=l.getKingSquare(e),l.isControlledBy(r,t)},l}function n(e,t){var r,n;return r=document.createElement("DIV"),r.className=v.square_piece,r.style.backgroundImage="url('"+t+"')",r.setAttribute("draggable","true"),n={div:r,name:e,square:null,url:t},n.dragEndHandler=function(e){var t="";n.square.board.isDragging&&(n.square.board.isDragging=!1,"function"==typeof n.square.board.onPieceDragEnd&&(t=n.square.name,n.square.board.onPieceDragEnd(t,e)))},n.dragStartHandler=function(e){var t="";n.square.board.draggablePieces&&(e.dataTransfer.effectAllowed="move",n.square.board.isDragging=!0,"function"==typeof n.square.board.onPieceDragStart&&(t=n.square.name,n.square.board.onPieceDragStart(t)))},n.initEventListeners=function(){r.addEventListener("dragstart",n.dragStartHandler),r.addEventListener("dragend",n.dragEndHandler)},n.put=function(e){e.isEmpty()||e.piece.remove(),e.div.appendChild(n.div),e.piece=n,n.square=e},n.remove=function(){null!==n.square&&(n.square.div.removeChild(n.div),n.square.piece=null)},n}function a(e){var t={board:null,canvas:null,div:null,hasCircle:!1,isHighlighted:!1,isMarked:!1,isOverflown:!1,isSelected:!1,name:e,piece:null};return t.clickHandler=function(){t.board.clickablePieces&&"function"==typeof t.board.onSquareClick&&t.board.onSquareClick(t.name)},t.dragEnterHandler=function(e){t.board.isDragging&&(e.preventDefault(),t.board.markOverflownSquare&&t.overfly())},t.dragLeaveHandler=function(){t.board.isDragging&&t.board.markOverflownSquare&&t.overfly()},t.dragOverHandler=function(e){t.board.isDragging&&e.preventDefault()},t.drawFilledCircle=function(e,r,n,a){var i=t.canvas.getContext("2d");i.beginPath(),i.arc(e,r,n,0,2*Math.PI),i.fillStyle=a,i.fill()},t.dropHandler=function(e){t.board.isDragging&&(e.preventDefault(),e.dataTransfer.dropEffect="move",t.board.markOverflownSquare&&t.overfly(),"function"==typeof t.board.onSquareDrop&&t.board.onSquareDrop(t.name))},t.getClassName=function(){var e=v.square+" ";return e+=a.isWhite(t.name)?v.white_square:v.black_square,t.isHighlighted&&(e+=" "+v.highlighted_square),t.isMarked&&(e+=" "+v.marked_square),t.isOverflown&&(e+=" "+v.overflown_square),t.isSelected&&(e+=" "+v.selected_square),e},t.highlight=function(){var e="";t.isHighlighted=!t.isHighlighted,e=t.getClassName(),O(function(){t.div.className=e})},t.isEmpty=function(){return null===t.piece},t.mark=function(){var e="";t.isMarked=!t.isMarked,e=t.getClassName(),O(function(){t.div.className=e})},t.overfly=function(){var e="";t.isOverflown=!t.isOverflown,e=t.getClassName(),O(function(){t.div.className=e})},t.select=function(){var e="";t.isSelected=!t.isSelected,e=t.getClassName(),O(function(){t.div.className=e})},t}function i(e,t){var i={legalMarksColor:t.legalMarksColor,clickablePieces:t.clickable,container:document.getElementById(e),draggablePieces:t.draggable,notationBorder:t.notationBorder,imagesExtension:t.imagesExtension,imagesPath:t.imagesPath,isDragging:!1,isFlipped:t.flipped,markOverflownSquare:t.markOverflownSquare,onPieceDragEnd:null,onPieceDragStart:null,onPromotionChose:null,onSquareClick:null,onSquareDrop:null,pendingMove:null,promotionDiv:document.createElement("DIV"),selectedSquare:null,squares:{},width:t.width};return i.clearMarks=function(){Object.keys(i.squares).forEach(function(e){var t=i.squares[e];t.isHighlighted&&t.highlight(),t.isMarked&&t.mark(),t.isOverflown&&t.overfly(),t.isSelected&&t.select()})},i.clickPromotionHandler=function(e){var t=e.target.name;"function"==typeof i.onPromotionChose&&i.onPromotionChose(t),i.pendingMove=null,i.unlock(),O(function(){i.promotionDiv.style.display="none"})},i.createSquares=function(){var e,t,r="",n=0,o="",s="",c=!1,l="",u=0,f=0,g={},h={},p=0;for(r=Math.floor(i.width/8)+"px",u=Math.floor(i.width/62),p=Math.floor(i.width/16),f=1;9>f;){for(n=1;9>n;)o=d[n-1],l=o+f,c=a.isWhite(l),e=document.createElement("CANVAS"),e.className=v.square_canvas,e.setAttribute("height",r),e.setAttribute("width",r),t=document.createElement("DIV"),s=c?v.square+" "+v.white_square:v.square+" "+v.black_square,t.className=s,g=new a(l),g.canvas=e,g.drawFilledCircle(p,p,u,i.legalMarksColor),g.board=i,g.div=t,t.addEventListener("click",g.clickHandler),t.addEventListener("dragenter",g.dragEnterHandler),t.addEventListener("dragleave",g.dragLeaveHandler),t.addEventListener("dragover",g.dragOverHandler),t.addEventListener("drop",g.dropHandler),h[l]=g,n+=1;f+=1}i.squares=h},i.draw=function(){var e,t,r,n,a,o=0,s="",c=0,l=0;if(i.promotionDiv.className=v.promotion_div,a=document.createElement("DIV"),a.style.width=i.width+"px",a.style.height=i.width+"px",a.className=v.squares_div,i.isFlipped)for(l=1;9>l;){for(o=8;o>0;)s=d[o-1],n=i.squares[s+l],a.appendChild(n.div),o-=1;l+=1}else for(l=8;l>0;){for(o=1;9>o;)s=d[o-1],n=i.squares[s+l],a.appendChild(n.div),o+=1;l-=1}if(i.container.appendChild(a),a.appendChild(i.promotionDiv),i.notationBorder){for(t=document.createElement("DIV"),t.className=v.bottom_border,t.style.width=i.width+"px",o=1;9>o;)e=document.createElement("DIV"),e.className=v.bottom_border_fragment,c=i.isFlipped?8-o:o-1,e.innerHTML=d[c].toUpperCase(),t.appendChild(e),o+=1;for(r=document.createElement("DIV"),r.className=v.right_border,r.style.height=i.width+"px",l=1;9>l;)e=document.createElement("DIV"),e.className=v.right_border_fragment,e.style.lineHeight=Math.floor(i.width/8)+"px",c=i.isFlipped?l:9-l,e.innerHTML=c,r.appendChild(e),l+=1;O(function(){i.container.appendChild(r),i.container.appendChild(t)})}},i.drawCircles=function(e){e.forEach(function(e){var t=i.squares[e];O(function(){t.hasCircle?t.div.removeChild(t.canvas):t.div.appendChild(t.canvas),t.hasCircle=!t.hasCircle})})},i.empty=function(){Object.keys(i.squares).forEach(function(e){var t=i.squares[e];t.isEmpty()||t.piece.remove()})},i.getPositionObject=function(){var e={};return Object.keys(i.squares).forEach(function(t){var r="",n="",a=i.squares[t];a.isEmpty()||(n=a.piece.name,r=n[0]===h.white?n[1].toUpperCase():n[1].toLowerCase(),e[t]=r)}),e},i.highlightSquares=function(e){e.forEach(function(e){i.squares[e].highlight()})},i.loadFEN=function(e){var t={};if(e=e||h.default_fen,!r.isValidFEN(e,!0))throw new SyntaxError(m.invalid_fen);i.empty(),t=r.fenToObject(e),Object.keys(t).forEach(function(e){var r="",a={},o="",s={},c="";r=t[e],o=r.toLowerCase()===r?h.black+r:h.white+r.toLowerCase(),c=i.imagesPath+o+i.imagesExtension,a=new n(o,c),a.initEventListeners(),s=i.squares[e],a.put(s)})},i.lock=function(){i.clickablePieces=!1,i.draggablePieces=!1},i.markSquares=function(e){e.forEach(function(e){i.squares[e].mark()})},i.play=function(e,t){var r="",a={},o=!1,s="",c={},l="",u="",f={},g={},v="",p="",b="",w={},q="";if(!y.test(e))throw new SyntaxError(m.invalid_parameter);if(b=e.substr(0,2),w=i.squares[b],w.isEmpty())throw new Error(m.illegal_move);if(f=w.piece,f.remove(),r=e.substr(3,2),a=i.squares[r],f.put(a),k.test(e)&&f.name[1]===h.black_king){switch(r[0]){case d[2]:p=d[0],v=d[3];break;case d[6]:p=d[7],v=d[5]}v+=r[1],p+=r[1],i.squares[p].isEmpty()||(g=i.squares[p].piece,g.remove(),g.put(i.squares[v]))}else if(f.name[1]===h.black_pawn)if(o=a.isEmpty(),_.test(e)&&o&&b[0]!==r[0]){switch(s=r[0],r[1]){case"3":s+="4";break;case"6":s+="5"}i.squares[s].isEmpty()||i.squares[s].piece.remove()}else C.test(e)&&(t=t||h.black_queen,l="1"===r[1]?h.black:h.white,u=l+t.toLowerCase(),q=i.imagesPath+u+i.imagesExtension,c=new n(u,q),c.initEventListeners(),f.remove(),c.put(a))},i.showPromotionDiv=function(e){for(var t=i.promotionDiv.childNodes,r=[h.black_queen,h.black_rook,h.black_bishop,h.black_knight];t.length>0;)i.promotionDiv.removeChild(i.promotionDiv.lastChild);r.forEach(function(t){var r,n=i.imagesPath+e+t+i.imagesExtension;r=document.createElement("INPUT"),r.className=v.promotion_button,r.setAttribute("type","button"),r.setAttribute("name",t),r.style.backgroundImage="url('"+n+"')",r.addEventListener("click",i.clickPromotionHandler),i.promotionDiv.appendChild(r)}),i.lock(),O(function(){i.promotionDiv.style.display="block"})},i.unlock=function(){i.clickablePieces=t.clickable,i.draggablePieces=t.draggable},i}function o(){var e={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},t={},n={};return Object.keys(e).forEach(function(r){t[r]=e[r]}),n={comments:[],fenStrings:[h.default_fen],moves:[],pgnMoves:[],tags:t},n.getNthPosition=function(e){var t="",a=0;if(a=n.fenStrings.length-1,"number"!=typeof e||0>e||e>a)throw new Error(m.invalid_parameter);return t=n.fenStrings[e],new r(t)},n.getPGN=function(){var e=0,r="\n",a="",i="";return Object.keys(t).forEach(function(e){var n=t[e];a+="["+e+' "'+n+'"]'+r}),a+=r,n.pgnMoves.forEach(function(t,n){var i=80,o="";n%2===0&&(o=n/2+1+"."),e+=o.length+1,e>i&&(a+=r,e=0),a+=o+" ",e+=t.length+1,e>i&&(a+=r,e=0),a+=t+" "}),i=n.getInfo("Result"),a+=i},n.getInfo=function(e){return t[e]},n.isInCheck=function(e){var t="",r={};return r=n.getNthPosition(e),t=r.activeColor,r.isInCheck(t)},n.isLegal=function(e,t){var r={};return y.test(t)?(r=n.getNthPosition(e),r.checkMoveLegality(t)):!1},n.play=function(e,t){var r={},a=!1,i=!1,o=!1,s=0,c={},l="",u="";if(!y.test(e))throw new SyntaxError(m.invalid_parameter);if(s=n.fenStrings.length-1,r=n.getNthPosition(s),r.checkMoveLegality(e))return t=t||"",c=r.getNextPosition(e,t),n.fenStrings.push(c.fenString),n.moves.push(e),i=c.isInCheck(c.activeColor),o=!c.hasLegalMoves(),a=c.isDrawByInsufficientMaterial()||c.isDrawBy50MovesRule(),i?o?(u=h.checkmate_symbol,c.activeColor===h.black?n.setTag("Result",h.result_white):n.setTag("Result",h.result_black)):u=h.check_symbol:o?n.setTag("Result",h.result_draw):a&&n.setTag("Result",h.result_draw),l=r.getPGNMove(e,t,!1,u),n.pgnMoves.push(l),c.fenString;throw new Error(m.illegal_move)},n.setPGN=function(r){var a=[],i=[];if(!o.isValidPGN(r))throw new SyntaxError(m.invalid_pgn);for(Object.keys(e).forEach(function(r){t[r]=e[r]}),n.fenStrings=[h.default_fen],n.moves=[],n.pgnMoves=[],n.tags=t,i=r.match(N),i.forEach(function(e){var t=[],r=/\[([^]+)\s"([^]*)"/gm;t=r.exec(e),n.setTag(t[1],t[2])});w.test(r);)r=r.replace(w,"");for(;S.test(r);)r=r.replace(S,"");r=r.replace(/\s{2,}/gm," "),a=r.match(E),a.forEach(function(e){e=e.replace(/[1-9][0-9]*\.(?:\.\.)?\s?/,""),n.pgnMoves.push(e)}),n.pgnMoves.forEach(function(e){var t={},r=0,a="",i={},o="",s="";r=n.fenStrings.length-1,t=n.getNthPosition(r),s=t.getSimpleNotation(e),-1!==s.indexOf(h.promotion_symbol)&&(o=s[s.length-1],s=s.replace(/\=[BNQR]$/,"")),i=t.getNextPosition(s,o),a=i.fenString,n.moves.push(s),n.fenStrings.push(a)})},n.setTag=function(e,r){t[e]=r},n}function s(e,r){var n="",a="",i="",o="",s="",c=0,l={};if(c=g.fenStrings.length-1,0>e||e>c)throw new Error(m.invalid_parameter);l=g.getNthPosition(e),r&&(n=l.fenString,f.loadFEN(n),c>e?f.lock():f.unlock()),t.markLastMove&&(f.clearMarks(),e>0&&(i=g.moves[e-1],s=i.substr(0,2),o=i.substr(3,2),f.highlightSquares([s,o]))),t.markKingInCheck&&l.isInCheck(l.activeColor)&&(f.clearMarks(),a=l.getKingSquare(l.activeColor),f.markSquares([a]))}function c(e){var r=[],n={},a=0;null===f.selectedSquare?f.selectedSquare=e:f.selectedSquare=null,t.markSelectedSquare&&f.squares[e].select(),t.markLegalSquares&&(a=g.fenStrings.length-1,n=g.getNthPosition(a),r=n.getLegalSquares(e),f.drawCircles(r))}function l(e,t){var r=0;f.play(e,t),g.play(e,t),r=g.fenStrings.length-1,s(r,!1),"function"==typeof b.onMovePlayed&&setTimeout(b.onMovePlayed,0)}function u(e,t){var r="",n="",a=0,i="",o={},s="";if(s=f.selectedSquare,n=s+"-"+e,!y.test(n))throw new Error(m.invalid_parameter);c(s),a=g.fenStrings.length-1,g.isLegal(a,n)?(o=g.getNthPosition(a),i=o.occupiedSquares[s],C.test(n)&&i.toLowerCase()===h.black_pawn?(f.pendingMove=n,r="8"===e[1]?h.white:h.black,f.showPromotionDiv(r)):l(n)):t&&e!==s&&!f.squares[e].isEmpty()&&c(e)}var f={},g={},d="abcdefgh",h={black:"b",black_bishop:"b",black_king:"k",black_knight:"n",black_pawn:"p",black_queen:"q",black_rook:"r",capture_symbol:"x",castle_king_symbol:"O-O",castle_queen_symbol:"O-O-O",check_symbol:"+",checkmate_symbol:"#",default_fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",promotion_symbol:"=",result_black:"0-1",result_draw:"1/2-1/2",result_white:"1-0",white:"w",white_bishop:"B",white_king:"K",white_knight:"N",white_pawn:"P",white_queen:"Q",white_rook:"R"},v={black_square:"square_black",bottom_border:"bottom-border",bottom_border_fragment:"bottom-border__fragment",highlighted_square:"square_highlighted",marked_square:"square_marked",overflown_square:"square_overflown",promotion_button:"promotion-button",promotion_div:"promotion-div",right_border:"right-border",right_border_fragment:"right-border__fragment",selected_square:"square_selected",square:"square",square_canvas:"square__canvas",square_piece:"square__piece",squares_div:"squares-div",white_square:"square_white"},p={clickable:!0,draggable:!0,flipped:!1,imagesExtension:".png",imagesPath:"images/wikipedia/",legalMarksColor:"steelblue",markKingInCheck:!0,markLastMove:!0,markLegalSquares:!0,markOverflownSquare:!0,markSelectedSquare:!0,notationBorder:!0,width:360},m={illegal_move:"Illegal move.",invalid_fen:"Invalid FEN string.",invalid_parameter:"Invalid parameter.",invalid_pgn:"Invalid PGN."},b={onMovePlayed:null},k=/^e(?:1-c1|1-g1|8-c8|8-g8)$/,w=/\{[^]+?\}/gm,_=/^[a-h]4-[a-h]3|[a-h]5-[a-h]6$/,q=/^(?:[bBkKnNpPqQrR1-8]{1,8}\/){7}[bBkKnNpPqQrR1-8]{1,8}\s(w|b)\s(KQ?k?q?|K?Qk?q?|K?Q?kq?|K?Q?k?q|-)\s([a-h][36]|-)\s(0|[1-9]\d*)\s([1-9]\d*)$/,P=/^[bknpqr1]{8}|[bknpqr12]{7}|[bknpqr1-3]{6}|[bknpqr1-4]{5}|[bknpqr1-5]{4}|[bknpqr1-6]{3}|[bknpqr]7|7[bknpqr]|8$/i,y=/^[a-h][1-8]-[a-h][1-8]$/,E=/(?:[1-9][0-9]*\.{1,3}\s*)?(?:O-O(?:-O)?|(?:[BNQR][a-h]?[1-8]?|K)x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:\=[BNQR])?)(?:\+|#)?/gm,C=/^[a-h]2-[a-h]1|[a-h]7-[a-h]8$/,N=/\[[A-Z][^]+?\s"[^]+?"\]/gm,S=/\([^()]*?\)/gm,O=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)};return r.fenToObject=function(e){var t={},r=/[1-8]/,n=/[bknpqr]/i,a="",i=[];return a=e.replace(/\s.*/,""),i=a.split("/"),i.forEach(function(e,a){var i=1,o=8-a;e.split("").forEach(function(e){var a="";if(n.test(e))a=d[i-1]+o,t[a]=e,i+=1;else{if(!r.test(e))throw new Error(m.invalid_fen);i+=Number(e)}})}),t},r.isValidFEN=function(e,t){var r=e.replace(/\s.*/,"").split("/");return t=t||!1,t||q.test(e)?r.every(function(e){return P.test(e)}):!1},r.objectToFEN=function(e){var t=0,r=0,n="",a=0,i="";for(a=8;a>0;){for(t=1,r=0;9>t;)i=d[t-1]+a,e.hasOwnProperty(i)?(r>0&&(n+=r,r=0),n+=e[i]):r+=1,8===t&&(r>0&&(n+=r),a>1&&(n+="/")),t+=1;a-=1}return n},a.isWhite=function(e){var t=0,r=0;return t=d.indexOf(e[0])+1,r=Number(e[1]),r%2===0?t%2===1:t%2===0},o.isValidPGN=function(e){function t(e){return n.test(e)}var r=[],n=/(?:[1-9][0-9]*\.(?:\.\.)?\s*)?(?:O-O(?:-O)?|(?:[BNQR][a-h]?[1-8]?|K)x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:\=[BNQR])?)(?:\+|#)?/gm,a=/1-0|0-1|1\/2-1\/2|\*/,i=/(?:\[[^]+?\s"[^]+?"\]\s+){7,}\s+/gm,o=[];if(!i.test(e))return!1;for(e=e.replace(i,"");w.test(e);)e=e.replace(w,"");for(;S.test(e);){if(o=e.match(S),!o.every(t))return!1;e=e.replace(S,"")}return r=e.match(n),r.length<1?!1:(e=e.replace(n,""),a.test(e))},t=t||{},Object.keys(p).forEach(function(e){t.hasOwnProperty(e)||(t[e]=p[e])}),f=new i(e,t),g=new o,f.onPieceDragEnd=function(e,t){"none"===t.dataTransfer.dropEffect&&c(e)},f.onPieceDragStart=function(e){null!==f.selectedSquare&&c(f.selectedSquare),c(e)},f.onPromotionChose=function(e){var t=f.pendingMove;l(t,e)},f.onSquareClick=function(e){null===f.selectedSquare?f.squares[e].isEmpty()||c(e):u(e,!0)},f.onSquareDrop=function(e){u(e,!1)},{DEFAULT_FEN:h.default_fen,draw:function(){f.createSquares(),f.draw()},flip:function(){var e=f.container;for(f.isFlipped=!f.isFlipped;e.hasChildNodes();)e.removeChild(e.lastChild);f.draw()},getActiveColor:function(e){var t={};return t=g.getNthPosition(e),t.activeColor},getFEN:function(e){var t=0;if(t=g.fenStrings.length-1,"number"!=typeof e||0>e||e>t)throw new Error(m.invalid_parameter);return g.fenStrings[e]},getGameInfo:function(e){return g.getInfo(e)},getGameMoves:function(){return g.moves},getGameMovesPGN:function(){return g.pgnMoves},getLastPositionIndex:function(){return g.fenStrings.length-1},getLegalMoves:function(e){var t={};return t=g.getNthPosition(e),t.getLegalMoves()},getPGN:function(){return g.getPGN()},is50MovesDraw:function(e){var t={};return t=g.getNthPosition(e),t.isDrawBy50MovesRule()},isCheckmate:function(e){var t={};return t=g.getNthPosition(e),t.isCheckmate()},isInCheck:function(e){var t="",r={};return r=g.getNthPosition(e),t=r.activeColor,r.isInCheck(t)},isInsufficientMaterialDraw:function(e){var t={};return t=g.getNthPosition(e),t.isDrawByInsufficientMaterial()},isLegal:function(e,t){return g.isLegal(e,t)},isStalemate:function(e){var t="",r={};return r=g.getNthPosition(e),t=r.activeColor,!r.isInCheck(t)&&!r.hasLegalMoves()},isValidFEN:function(e,t){return r.isValidFEN(e,t)},isValidPGN:function(e){return o.isValidPGN(e)},navigate:function(e){return s(e,!0)},onMovePlayed:function(e){if("function"!=typeof e)throw new Error(m.invalid_parameter);b.onMovePlayed=e},play:function(e,t){return l(e,t)},reset:function(){f.loadFEN(),f.clearMarks(),g=new o},setFEN:function(e){f.loadFEN(e)},setGameInfo:function(e,t){return g.setTag(e,t)},setPGN:function(e){g.setPGN(e)}}};